<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Stock Scenario Manager — Full Enhanced (with Summary Questions)</title>

<!-- Fonts & Icons -->
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet">

<!-- Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<!-- Add these for smooth zoom and image preview -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/viewerjs/1.11.6/viewer.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/viewerjs/1.11.6/viewer.min.js"></script>

<style>
/* ---------------- THEME VARIABLES ---------------- */
:root{
  --primary: #4f46e5;         /* Indigo for primary actions */
  --primary-light: #6366f1;
  --accent:  #f43f5e;         /* Vibrant pink accent */
  --bg:      #f3f4f6;         /* Soft gray background */
  --card:    #ffffff;
  --success: #22c55e;
  --danger:  #ef4444;
  --warning: #f59e0b;
  --muted:   #6b7280;

  /* sizes */
  --radius-lg: 16px;
  --radius-md: 12px;
  --radius-sm: 8px;
}

/* ---------------- BASE ---------------- */
*{box-sizing:border-box}
html,body{height:100%}
body{
  font-family: 'Poppins', sans-serif;
  background: linear-gradient(135deg, #f8fafc 0%, #eef2ff 100%);
  color: #0f172a;
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
  padding: 28px 18px;
}

/* container */
.container{max-width:1200px;margin:0 auto}

/* headings */
h1, h2, h3, h4 { margin:0; }
h1{ color:var(--primary); font-weight:700; font-size:1.6rem; margin-bottom:1rem;}

/* ---------------- LOGIN (keeps same toggle behavior) ---------------- */
#login-page { display:flex; align-items:center; justify-content:center; min-height:calc(100vh - 56px); padding: 20px; }
.login-wrap { width:100%; display:flex; align-items:center; justify-content:center; }
.login-container {
  background: linear-gradient(180deg, rgba(255,255,255,0.96), rgba(255,255,255,0.98));
  border-radius: 20px;
  box-shadow: 0 12px 40px rgba(79,70,229,0.12);
  padding: 32px;
  width:100%;
  max-width:420px;
  text-align:center;
  transition: transform .25s ease, box-shadow .25s ease;
}
.login-container:hover{ transform: translateY(-4px); box-shadow: 0 18px 60px rgba(79,70,229,0.16); }

.login-brand {
  display:flex;
  align-items:center;
  gap:12px;
  justify-content:center;
  margin-bottom:12px;
}
.logo-mark {
  width:48px;height:48px;border-radius:10px;
  background: linear-gradient(135deg,var(--primary),var(--primary-light));
  display:inline-flex;align-items:center;justify-content:center;color:#fff;font-weight:700;box-shadow:0 6px 18px rgba(79,70,229,0.2);
}
.login-container h2 { font-weight:700; color:var(--primary); font-size:1.25rem; margin-bottom:6px;}
.login-container p { color:var(--muted); margin-bottom:18px; }

/* inputs & buttons */
.form-control {
  border-radius: 12px;
  border: 1px solid #e6e9f2;
  padding: .78rem .9rem;
  font-size: .95rem;
  box-shadow: none;
  transition: box-shadow .15s ease, border-color .15s ease;
}
.form-control:focus{ border-color: var(--primary); box-shadow: 0 6px 20px rgba(99,102,241,0.08); outline: none; }

.btn-primary {
  background: linear-gradient(135deg, var(--primary), var(--primary-light));
  border: none;
  border-radius: 999px;
  padding: .68rem 1rem;
  font-weight:600;
  box-shadow: 0 8px 26px rgba(79,70,229,0.12);
}
.btn-primary:hover{ transform: translateY(-2px); }

/* login error */
#login-error { display:none; color:var(--danger); font-size:.9rem; margin-top:12px; }

/* small footer */
.login-footer{ margin-top:16px; color:var(--muted); }

/* ---------------- NAV & TABS ---------------- */
.nav-tabs {
  border-bottom: none;
  display:flex;
  gap:6px;
  flex-wrap:wrap;
  margin-bottom:1rem;
}
.nav-tabs .nav-link{
  border-radius: 999px;
  padding: .48rem .9rem;
  background:transparent;
  color:var(--muted);
  border: none;
  font-weight:600;
  transition: all .18s ease;
}
.nav-tabs .nav-link.active{
  color:#fff;
  background: linear-gradient(90deg,var(--primary),var(--primary-light));
  box-shadow: 0 8px 26px rgba(79,70,229,0.08);
}

/* tab content card */
.tab-content{
  background: var(--card);
  padding: 18px;
  border-radius: var(--radius-md);
  box-shadow: 0 6px 26px rgba(15,23,42,0.04);
}

/* ---------------- GENERAL CARDS / LISTS ---------------- */
.card{
  border-radius: var(--radius-lg);
  box-shadow: 0 6px 20px rgba(15,23,42,0.04);
  border: none;
  transition: transform .18s ease, box-shadow .18s ease;
}
.card:hover{ transform: translateY(-3px); box-shadow: 0 16px 40px rgba(15,23,42,0.06); }

/* card header style */
.card-header{
  background: linear-gradient(90deg,var(--primary),var(--primary-light));
  color:#fff;
  font-weight:700;
  border-top-left-radius: calc(var(--radius-lg) - 4px);
  border-top-right-radius: calc(var(--radius-lg) - 4px);
  padding: 12px 16px;
}

/* scenario card (list of daily scenarios) */
.scenario-card{
  display:flex;
  gap:16px;
  align-items:center;
  padding:14px;
  border-radius:12px;
  background:linear-gradient(180deg,#fff,#fbfbff);
  border:1px solid rgba(15,23,42,0.03);
  box-shadow: 0 6px 18px rgba(79,70,229,0.03);
}
.scenario-card img{width:120px;height:80px;object-fit:cover;border-radius:8px;flex-shrink:0}
.scenario-card h5{margin:0;font-size:1rem}
.scenario-status{font-weight:700;padding:6px 10px;border-radius:10px;color:#fff;font-size:.78rem;text-transform:uppercase}
.pass{background:var(--success)}.fail{background:var(--danger)}.not-produced{background:var(--warning)}
.btn-group .btn{ border-radius:10px; }

/* small muted style */
.small-muted{ color:var(--muted); }

/* ---------------- FORM ELEMENTS ---------------- */
.form-select{ border-radius:12px; padding:.7rem; }
textarea.form-control{ border-radius:12px; }

/* ---------------- TABLES ---------------- */
.table thead th{
  border-bottom: none;
  font-weight:700;
  background: linear-gradient(90deg,var(--primary),var(--primary-light));
  color:#fff;
}
.table-striped tbody tr { transition: background .15s ease; }
.table-striped tbody tr:hover { background: rgba(79,70,229,0.04); }

/* badges (consistent) */
.badge-pass{ background:var(--success); color:#fff; border-radius:10px; padding:.45rem .6rem; font-weight:700; }
.badge-fail{ background:var(--danger); color:#fff; border-radius:10px; padding:.45rem .6rem; font-weight:700; }
.badge-not{ background:var(--warning); color:#111827; border-radius:10px; padding:.45rem .6rem; font-weight:700; }

/* small icon circular buttons used in header */
.summary-small-btn{ width:44px; height:44px; border-radius:50%; display:inline-flex; align-items:center; justify-content:center; margin-left:8px; border:none }
.summary-flag{ background: #fff; border:1px solid #e8eefc; box-shadow: 0 6px 16px rgba(15,23,42,0.03); color:var(--muted) }
.summary-filled{ background:var(--success); color:#fff; box-shadow: 0 8px 26px rgba(34,197,94,0.09) }

/* image preview in forms */
.image-preview-item{ position:relative; width:80px; height:80px; border-radius:10px; overflow:hidden; box-shadow:0 6px 18px rgba(15,23,42,0.04); }
.image-preview-item img{ width:100%; height:100%; object-fit:cover; display:block; }
.image-preview-item .remove-btn {
  position: absolute;
  top: -6px;
  right: -6px;
  background: var(--danger);
  color: #fff;
  border-radius: 50%;
  width: 22px;
  height: 22px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 12px;
  cursor: pointer;
  box-shadow: 0 2px 6px rgba(0,0,0,0.2);
}
/* modal header */
.modal-header{
  background: linear-gradient(135deg, var(--primary-light), var(--primary));
  color: #fff;
  font-weight: 700;
  border-top-left-radius: 12px;
  border-top-right-radius: 12px;
  border-bottom: none;
  box-shadow: 0 2px 6px rgba(0,0,0,0.12);
}
.modal-content{ border-radius: 14px; overflow:hidden; }

/* list-group item modern */
.list-group-item{ border-radius:12px; margin-bottom:8px; border: 1px solid rgba(15,23,42,0.03); }

/* rule card */
.rule-item{ border-radius:10px; border:1px solid rgba(15,23,42,0.03); background:#fff; box-shadow:0 6px 14px rgba(15,23,42,0.02); padding:12px; }

/* danger small */
.text-danger-small{ color:var(--danger); font-size:.9rem }

/* Ensure images in modal layout properly and are constrained */
#viewScenarioModal .zoom-img,
#viewScenarioModal .safe-zoom,
#viewScenarioModal .zoom-wrap img,
#viewScenarioModal .row img {
  width: 100%;
  max-width: 100%;
  max-height: 72vh;           /* keep image inside modal vertically */
  height: auto;
  object-fit: contain;        /* ensure full image is visible */
  border-radius: 8px;
  cursor: grab;
  touch-action: none;         /* we'll handle gestures */
  transition: transform 160ms ease-out; /* smooth transforms */
  display: block;
  margin: 0 auto;
}

/* While dragging change cursor */
#viewScenarioModal .zoom-img.dragging,
#viewScenarioModal .safe-zoom.dragging {
  cursor: grabbing;
}

/* Container that holds inline images (modal grid) - keeps a consistent gap */
#viewScenarioModal .row > .col-md-4 { display:flex; align-items:center; justify-content:center; }


/* responsive tweaks */
@media (max-width:768px){
  .scenario-card{ flex-direction:row; gap:12px }
  .login-container{ padding:20px; max-width: 100%; border-radius:12px; }
}

/* subtle animation for cards */
@keyframes fadeUp { 0%{opacity:0; transform:translateY(8px)} 100%{opacity:1; transform:translateY(0)} }
.card, .scenario-card, .list-group-item { animation: fadeUp .42s ease both; }
</style>
</head>
<body>

<!-- LOGIN (keeps existing on-page toggle behavior) -->
<div id="login-page" class="login-wrap">
  <div class="login-container text-center" aria-live="polite">
    <div class="login-brand">
      <div class="logo-mark">SS</div>
      <div style="text-align:left">
        <h2 class="mb-0">Stock Scenario Manager</h2>
        <div style="font-size:.85rem;color:var(--muted)">Login with Username & Password</div>
      </div>
    </div>

    <form id="login-form" class="mt-3">
      <div class="mb-3"><input type="text" class="form-control" id="username" placeholder="Username" required></div>
      <div class="mb-3"><input type="password" class="form-control" id="password" placeholder="Password" required></div>
      <button class="btn btn-primary w-100 fw-bold" type="submit">Login</button>
      <div id="login-error" class="mt-3 small"></div>
    </form>

    <div class="login-footer small-muted mt-3">
      <span>Need help? </span><a href="#" onclick="alert('Contact admin')">Contact admin</a>
    </div>
  </div>
</div>

<!-- MAIN APP (initially hidden; same behavior as your original file) -->
<div id="main-app" class="container" style="display:none; padding-top:28px;">
  <h1 class="text-center mb-4">Stock Scenario Manager</h1>

  <ul class="nav nav-tabs mb-4" id="tabs" role="tablist">
    <li class="nav-item"><button class="nav-link active" data-bs-target="#daily" data-bs-toggle="tab" type="button" role="tab">Daily Scenario</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-target="#report" data-bs-toggle="tab" type="button" role="tab">Report</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-target="#config" data-bs-toggle="tab" type="button" role="tab">Configuration</button></li>
  </ul>

  <div class="tab-content">
    <!-- DAILY -->
    <div class="tab-pane fade show active" id="daily" role="tabpanel">
      <div class="row align-items-end mb-3">
        <div class="col-md-4">
          <label class="form-label fw-bold">Select Date</label>
          <input type="date" id="date-picker" class="form-control">
        </div>
        <div class="col-md-8 text-end">
          <button id="add-new-scenario" class="btn btn-primary"><i class="fas fa-plus-circle me-1"></i> Add Scenario</button>
          <button id="refresh-daily" class="btn btn-outline-secondary"><i class="fas fa-sync me-1"></i> Refresh</button>

          <!-- Summary button -->
          <button id="open-summary-btn" title="Fill/View today's summary" class="summary-small-btn summary-flag" style="margin-left:8px">
            <i class="fas fa-clipboard-list"></i>
          </button>
        </div>
      </div>

      <hr />

      <div id="summary-banner" class="mb-3"></div>

      <div id="scenario-cards-container">
        <div class="text-center small-muted p-5">
          <i class="fas fa-info-circle fa-2x mb-2"></i>
          <p>No scenarios found for this date. Click "Add Scenario" to start.</p>
        </div>
      </div>
    </div>

    <!-- REPORT -->
    <div class="tab-pane fade" id="report" role="tabpanel">
      <h4 class="mb-3">Scenario Report</h4>

      <div class="card p-3 mb-3">
        <div class="row g-2">
          <div class="col-md-4"><label class="form-label">From Date</label><input type="date" id="report-from" class="form-control"></div>
          <div class="col-md-4"><label class="form-label">To Date</label><input type="date" id="report-to" class="form-control"></div>
          <div class="col-md-4 d-flex align-items-end"><button id="filter-report" class="btn btn-primary w-100">Filter</button></div>
        </div>
      </div>

      <div id="report-summary" class="mb-3"></div>

      <div class="card mb-4">
        <div class="card-header fw-bold">Detailed Scenario Report</div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-striped" id="report-table">
              <thead>
                <tr><th>Scenario Title</th><th>Date</th><th>Status</th><th>Rules Passed</th><th>Explanation</th><th>Actions</th></tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- SUMMARY QUESTIONS REPORT: Separate & specific -->
      <div class="card">
        <div class="card-header fw-bold" style="background:#111827; color:white;">Summary Questions Report</div>
        <div class="card-body">
          <div class="row g-2 mb-3 align-items-end">
            <div class="col-md-4"><label class="form-label">From</label><input type="date" id="summary-report-from" class="form-control"></div>
            <div class="col-md-4"><label class="form-label">To</label><input type="date" id="summary-report-to" class="form-control"></div>
            <div class="col-md-4 d-flex"><button id="filter-summary-report" class="btn btn-primary w-100">Show Summary Report</button></div>
          </div>

          <div id="summary-report-container">
            <div class="text-muted small">Use the date filters above and click "Show Summary Report".</div>
          </div>
        </div>
      </div>
    </div>

    <!-- CONFIG -->
    <div class="tab-pane fade" id="config" role="tabpanel">
      <div class="text-end mb-3">
        <button class="btn btn-success" id="open-add-config"><i class="fas fa-plus me-1"></i> Add New Configuration</button>
        <button class="btn btn-outline-primary" id="open-manage-summary-questions"><i class="fas fa-question-circle me-1"></i> Manage Summary Questions</button>
      </div>

      <div id="config-list"></div>
    </div>
  </div>
</div>

<!-- ---------------- MODALS ---------------- -->

<!-- Summary Modal (Fill/View today's summary) -->
<div class="modal fade" id="summaryModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title" id="summaryModalTitle">Daily Summary</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <div id="summary-modal-body">
          <div class="text-muted">Loading questions...</div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-danger me-auto" id="delete-today-summary">Delete Today's Summary</button>
        <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button class="btn btn-primary" id="save-today-summary">Save Summary</button>
      </div>
    </div>
  </div>
</div>

<!-- Summary Question Management Modal -->
<div class="modal fade" id="manageSummaryQuestionsModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title">Manage Summary Questions</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <form id="summary-question-form" class="row g-2 align-items-end mb-3">
          <input type="hidden" id="summary-q-id">
          <div class="col-md-10"><input id="summary-q-text" class="form-control" placeholder="Question text"></div>
          <div class="col-md-2"><button id="add-summary-q-btn" type="button" class="btn btn-success w-100"><i class="fas fa-plus-circle me-1"></i> Add</button></div>
        </form>
        <div id="summary-questions-list"></div>
      </div>
      <div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">Done</button></div>
    </div>
  </div>
</div>

<!-- Add/Edit Scenario Modal -->
<div class="modal fade" id="addScenarioModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addScenarioTitle">Add Daily Scenario</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="scenario-form">
          <input type="hidden" id="daily-scenario-id" />
          <div class="mb-3">
            <label class="form-label">Scenario</label>
            <select id="scenario-select" class="form-select" required></select>
          </div>
          <div class="mb-3">
            <label class="form-label">Status</label>
            <select id="status-select" class="form-select" required>
              <option value="" disabled selected>Select Status</option>
              <option value="pass">Pass</option>
              <option value="fail">Fail</option>
              <option value="not-produced">Not Produced</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Explanation</label>
            <textarea id="explanation-input" class="form-control" rows="3"></textarea>
          </div>
          <div class="mb-3">
            <label class="form-label">Image Upload</label>
            <input id="image-upload" type="file" class="form-control" accept="image/*" multiple>
            <div id="image-preview-container" class="d-flex flex-wrap gap-2 mt-2"></div>
          </div>
          <hr />
          <div id="daily-rules-container">
            <div class="alert alert-info text-center">Select a scenario to load rules.</div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button id="save-daily-scenario" class="btn btn-primary">Save Scenario</button>
      </div>
    </div>
  </div>
</div>

<!-- View Scenario Modal -->
<div class="modal fade" id="viewScenarioModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Scenario Details</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="view-scenario-body"></div>
      <div class="modal-footer">
        <button id="view-manage-rules" class="btn btn-outline-primary d-none"><i class="fas fa-tasks me-1"></i> Manage Rules</button>
        <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Add/Edit Config Modal -->
<div class="modal fade" id="addConfigModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="configModalTitle">Add Configuration</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="config-form">
          <input type="hidden" id="config-id">
          <div class="mb-3">
            <label class="form-label">Scenario Title</label>
            <input id="config-title" class="form-control" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Description</label>
            <textarea id="config-description" class="form-control" rows="3"></textarea>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3"><label class="form-label">Entry Point</label><input id="entry-point" class="form-control"></div>
            <div class="col-md-6 mb-3"><label class="form-label">Exit Point</label><input id="exit-point" class="form-control"></div>
          </div>
          <div class="text-end">
            <button id="manage-config-rules" type="button" class="btn btn-outline-primary"><i class="fas fa-tasks me-1"></i> Manage Rules</button>
          </div>
        </form>
      </div>
      <div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">Close</button><button id="save-config" class="btn btn-primary">Save Configuration</button></div>
    </div>
  </div>
</div>

<!-- View Config Modal -->
<div class="modal fade" id="viewConfigModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered"><div class="modal-content">
    <div class="modal-header"><h5 class="modal-title">Configuration Details</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
    <div class="modal-body" id="view-config-body"></div>
    <div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">Close</button></div>
  </div></div>
</div>

<!-- Manage Rules Modal -->
<div class="modal fade" id="manageRulesModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered"><div class="modal-content">
    <div class="modal-header">
      <h5 class="modal-title">Manage Rules for <span id="rules-scenario-title" class="text-primary"></span></h5>
      <button class="btn-close" data-bs-dismiss="modal"></button>
    </div>
    <div class="modal-body">
      <form id="add-rule-form" class="row g-2 mb-3 align-items-end">
        <div class="col-md-6"><label class="form-label">Rule Name</label><input id="rule-name" class="form-control"></div>
        <div class="col-md-4"><label class="form-label">Condition</label><input id="rule-condition" class="form-control"></div>
        <div class="col-md-2"><button id="add-rule-btn" class="btn btn-success w-100" type="button"><i class="fas fa-plus-circle"></i></button></div>
      </form>

      <hr>
      <ul id="rules-list" class="list-group"></ul>
    </div>
    <div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">Done</button></div>
  </div></div>
</div>

<!-- jQuery & Bootstrap JS -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.min.js"></script>

<!-- ---------------- Keep all existing JS logic (unchanged) ---------------- -->
<script>
$(function(){

  // ---------- State ----------
  let dailyScenarios = JSON.parse(localStorage.getItem('dailyScenarios') || '{}'); // {date: [scen..]}
  let configurations = JSON.parse(localStorage.getItem('configurations') || '[]'); // [config..]
  let currentImages = [];
  let manageRulesForConfig = null;

  // New storage for summary questions & daily summary
  let summaryQuestions = JSON.parse(localStorage.getItem('summaryQuestions') || '[]');
  let dailySummaries = JSON.parse(localStorage.getItem('dailySummaries') || '{}');

  // ---------- Helpers ----------
  function persistAll(){
    localStorage.setItem('dailyScenarios', JSON.stringify(dailyScenarios));
    localStorage.setItem('configurations', JSON.stringify(configurations));
    localStorage.setItem('summaryQuestions', JSON.stringify(summaryQuestions));
    localStorage.setItem('dailySummaries', JSON.stringify(dailySummaries));
  }
  function todayISO(){ return new Date().toISOString().slice(0,10); }
  function escapeHtml(s){ return String(s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

  // ---------- UI Populate ----------
  function populateScenarioDropdown(){
    const sel = $('#scenario-select').empty();
    sel.append('<option value="" disabled selected>Select a Scenario</option>');
    configurations.forEach(c => sel.append(`<option value="${c.id}">${escapeHtml(c.title)}</option>`));
  }

  function renderDailyScenarios(){
    const date = $('#date-picker').val();
    const container = $('#scenario-cards-container').empty();
    const list = dailyScenarios[date] || [];
    renderSummaryBanner(date);

    if (!list.length){
      container.html('<div class="text-center small-muted p-5"><i class="fas fa-info-circle fa-2x mb-2"></i><p>No scenarios found for this date. Click "Add Scenario".</p></div>');
      return;
    }
    list.forEach(s => {
      const cfg = configurations.find(c=>c.id==s.configId) || { title:'Unknown' };
      const img = (s.images && s.images.length) ? s.images[0] : 'https://via.placeholder.com/150';
      const statusClass = s.status === 'pass' ? 'pass' : (s.status === 'fail' ? 'fail' : 'not-produced');
      const card = $(`
        <div class="scenario-card mb-3" data-id="${s.id}">
          <img src="${img}" alt="img">
          <div style="flex:1">
            <h5 class="mb-1">${escapeHtml(cfg.title)}</h5>
            <p class="mb-1 small text-muted">Status: <span class="scenario-status ${statusClass}">${(s.status||'').toUpperCase()}</span></p>
            <p class="mb-2 small">${escapeHtml((s.explanation||'').slice(0,100))}${(s.explanation && s.explanation.length>100? '...' : '')}</p>
            <div class="btn-group btn-group-sm">
              <button class="btn btn-info btn-view" data-id="${s.id}"><i class="fas fa-eye"></i> View</button>
              <button class="btn btn-warning btn-edit" data-id="${s.id}"><i class="fas fa-edit"></i> Edit</button>
              <button class="btn btn-danger btn-delete" data-id="${s.id}"><i class="fas fa-trash"></i> Delete</button>
            </div>
          </div>
        </div>
      `);
      container.append(card);
    });
  }

  function renderConfigurations(){
    const list = $('#config-list').empty();
    if (!configurations.length){
      list.html('<div class="alert alert-info text-center">No configurations found. Add new ones.</div>');
      return;
    }
    configurations.forEach(c => {
      const el = $(`
        <div class="list-group-item d-flex justify-content-between align-items-center mb-2 card">
          <div class="w-75">
            <h5 class="mb-1">${escapeHtml(c.title)}</h5>
            <p class="mb-1 small text-muted">${escapeHtml((c.description||'').slice(0,120))}${(c.description && c.description.length>120? '...' : '')}</p>
            <p class="mb-0 small"><strong>Entry:</strong> ${escapeHtml(c.entryPoint||'N/A')} | <strong>Exit:</strong> ${escapeHtml(c.exitPoint||'N/A')}</p>
          </div>
          <div class="btn-group btn-group-sm">
            <button class="btn btn-info btn-view-config" data-id="${c.id}"><i class="fas fa-eye"></i> View</button>
            <button class="btn btn-warning btn-edit-config" data-id="${c.id}"><i class="fas fa-edit"></i> Edit</button>
            <button class="btn btn-danger btn-delete-config" data-id="${c.id}"><i class="fas fa-trash-alt"></i> Delete</button>
            <button class="btn btn-secondary btn-copy-config" data-id="${c.id}"><i class="fas fa-copy"></i> Copy</button>
          </div>
        </div>
      `);
      list.append(el);
    });
  }

  // ---------- Report Rendering ----------
  function renderReport(from=null,to=null){
    const tbody = $('#report-table tbody').empty();
    const summary = { total:0, pass:0, fail:0, 'not-produced':0 };
    const grouped = {}; // scenarioTitle => [items]
    const rows = [];

    Object.keys(dailyScenarios).sort().forEach(date => {
      if (from && date < from) return;
      if (to && date > to) return;
      (dailyScenarios[date]||[]).forEach(s => {
        const cfg = configurations.find(c=>c.id==s.configId) || { title:'Unknown' };
        summary.total++;
        if (s.status) summary[s.status] = (summary[s.status]||0) + 1;
        const passed = (s.rules||[]).filter(r=>r.status==='pass').length;
        rows.push({ title: cfg.title, date, status: s.status||'N/A', passed, totalRules:(s.rules||[]).length, explanation: s.explanation||'', id: s.id });
        if (!grouped[cfg.title]) grouped[cfg.title] = [];
        grouped[cfg.title].push({ date, status: s.status||'N/A' });
      });
    });

    const total = summary.total || 0;
    const summaryHtml = `
      <div class="row text-center fw-bold mb-2">
        <div class="col-md-3">Total: <span class="badge bg-primary">${total}</span></div>
        <div class="col-md-3">Pass: <span class="badge bg-success">${summary.pass||0} (${total?((summary.pass/total*100).toFixed(1)):'0.0'}%)</span></div>
        <div class="col-md-3">Fail: <span class="badge bg-danger">${summary.fail||0} (${total?((summary.fail/total*100).toFixed(1)):'0.0'}%)</span></div>
        <div class="col-md-3">Not Produced: <span class="badge bg-warning">${summary['not-produced']||0} (${total?(((summary['not-produced']||0)/total*100).toFixed(1)):'0.0'}%)</span></div>
      </div>
    `;

    // scenario-wise grouped cards
    let groupedHtml = '<div class="mb-3">';
    Object.keys(grouped).forEach(title => {
      groupedHtml += `<div class="card mb-2"><div class="card-header fw-bold">${escapeHtml(title)}</div><div class="card-body"><div class="row">`;
      grouped[title].forEach(item => {
        groupedHtml += `<div class="col-md-3 mb-2"><div class="p-2" style="background:${item.status==='pass'?'#e8f5e9':(item.status==='fail'?'#ffebee':'#fff7e6')};border-radius:8px"><strong>${item.date}</strong><div><span class="badge ${item.status==='pass'?'badge-pass':item.status==='fail'?'badge-fail':'badge-not'}">${(item.status||'').toUpperCase()}</span></div></div></div>`;
      });
      groupedHtml += '</div></div></div>';
    });
    groupedHtml += '</div>';

    $('#report-summary').html(summaryHtml + groupedHtml);

    // detailed rows
    rows.forEach(r => {
      const cls = r.status==='pass' ? 'bg-success text-white' : (r.status==='fail' ? 'bg-danger text-white' : 'bg-warning text-dark');
      tbody.append(`<tr>
        <td>${escapeHtml(r.title)}</td>
        <td>${r.date}</td>
        <td><span class="badge ${cls}">${(r.status||'').toUpperCase()}</span></td>
        <td>${r.passed} of ${r.totalRules}</td>
        <td>${escapeHtml(r.explanation.slice(0,60))}${(r.explanation.length>60?'...':'')}</td>
        <td><button class="btn btn-info btn-sm btn-view-report" data-id="${r.id}"><i class="fas fa-info-circle"></i> Details</button></td>
      </tr>`);
    });
  }

  // ---------- Summary Features ----------
  function renderSummaryBanner(date){
    const summary = dailySummaries[date];
    const banner = $('#summary-banner').empty();
    if (!summary){
      $('#open-summary-btn').removeClass('summary-filled').addClass('summary-flag');
      banner.html('<div class="alert alert-light small-muted">No summary filled for this date.</div>');
    } else {
      $('#open-summary-btn').removeClass('summary-flag').addClass('summary-filled');
      const counts = { Yes:0, No:0, NA:0 };
      (summary.answers||[]).forEach(a => { counts[a.answer] = (counts[a.answer]||0) + 1; });
      banner.html(`<div class="small"><strong>Summary:</strong> ${Object.keys(counts).map(k=>`${k}: ${counts[k]}`).join(' | ')} — <span class="small text-muted">Filled on ${summary.createdAt.split('T')[0]}</span></div>`);
    }
  }

  function buildSummaryModal(date){
    const body = $('#summary-modal-body').empty();
    const questions = summaryQuestions.slice();
    if (!questions.length){
      body.html('<div class="alert alert-info">No summary questions configured. Use Configuration → Manage Summary Questions to add.</div>');
      return;
    }
    const todaySummary = dailySummaries[date] || null;
    const answersMap = {};
    if (todaySummary && todaySummary.answers){
      todaySummary.answers.forEach(a=> answersMap[a.qId] = a);
    }

    const list = $('<div class="list-group"></div>');
    questions.forEach((q, idx) => {
      const saved = answersMap[q.id] || {};
      const item = $(`
        <div class="list-group-item mb-2">
          <div class="d-flex justify-content-between align-items-start">
            <div style="flex:1">
              <h6 class="mb-1">${(idx+1)}. ${escapeHtml(q.text)}</h6>
            </div>
          </div>
          <div class="mt-2 d-flex gap-3 align-items-center">
            <div class="form-check">
              <input class="form-check-input summary-answer-radio" type="radio" name="q_${q.id}" id="q_${q.id}_yes" value="Yes" ${saved.answer==='Yes'?'checked':''}>
              <label class="form-check-label" for="q_${q.id}_yes">Yes</label>
            </div>
            <div class="form-check">
              <input class="form-check-input summary-answer-radio" type="radio" name="q_${q.id}" id="q_${q.id}_no" value="No" ${saved.answer==='No'?'checked':''}>
              <label class="form-check-label" for="q_${q.id}_no">No</label>
            </div>
            <div class="form-check">
              <input class="form-check-input summary-answer-radio" type="radio" name="q_${q.id}" id="q_${q.id}_na" value="NA" ${saved.answer==='NA'?'checked':''}>
              <label class="form-check-label" for="q_${q.id}_na">NA</label>
            </div>

            <div style="flex:1">
              <input class="form-control form-control-sm summary-comment" data-qid="${q.id}" placeholder="Optional comment (not included in summary report)" value="${escapeHtml(saved.comment || '')}">
            </div>
          </div>
        </div>
      `);
      list.append(item);
    });
    body.append(list);
  }

  function saveSummaryForDate(date){
    if (!date) { alert('Select a date'); return; }
    const answers = [];
    summaryQuestions.forEach(q => {
      const sel = $(`input[name="q_${q.id}"]:checked`).val() || null;
      const comment = $(`.summary-comment[data-qid="${q.id}"]`).val() || '';
      if (sel) answers.push({ qId: q.id, answer: sel, comment: comment });
      else answers.push({ qId: q.id, answer: 'NA', comment: comment }); // default NA if not selected
    });
    const id = (dailySummaries[date] && dailySummaries[date].id) || Date.now().toString();
    dailySummaries[date] = { id, date, answers, createdAt: new Date().toISOString() };
    persistAll();
    renderDailyScenarios();
    bootstrap.Modal.getOrCreateInstance(document.getElementById('summaryModal')).hide();
  }

  function deleteSummaryForDate(date){
    if (!date) return;
    if (!dailySummaries[date]) return alert("No summary to delete for this date");
    if (!confirm('Delete summary for ' + date + '?')) return;
    delete dailySummaries[date];
    persistAll();
    renderDailyScenarios();
    bootstrap.Modal.getOrCreateInstance(document.getElementById('summaryModal')).hide();
  }

  // ---------- Summary questions management ----------
  function renderSummaryQuestionsList(){
    const list = $('#summary-questions-list').empty();
    if (!summaryQuestions.length){
      list.html('<div class="alert alert-info">No summary questions. Add one above.</div>');
      return;
    }
    summaryQuestions.forEach((q, idx) => {
      const el = $(`
        <div class="list-group-item d-flex justify-content-between align-items-center mb-2 card">
          <div><strong>${idx+1}.</strong> ${escapeHtml(q.text)}</div>
          <div class="btn-group btn-group-sm">
            <button class="btn btn-warning btn-edit-summary-q" data-id="${q.id}"><i class="fas fa-edit"></i></button>
            <button class="btn btn-danger btn-delete-summary-q" data-id="${q.id}"><i class="fas fa-trash-alt"></i></button>
          </div>
        </div>
      `);
      list.append(el);
    });
  }

  $('#add-summary-q-btn').on('click', function(){
    const text = $('#summary-q-text').val().trim();
    if (!text) return alert('Enter question text');
    const id = $('#summary-q-id').val() || Date.now().toString();
    const idx = summaryQuestions.findIndex(s=>s.id==id);
    const obj = { id, text };
    if (idx >= 0) summaryQuestions[idx] = obj; else summaryQuestions.push(obj);
    $('#summary-q-id').val(''); $('#summary-q-text').val('');
    persistAll();
    renderSummaryQuestionsList();
  });

  $(document).on('click', '.btn-delete-summary-q', function(){
    const id = $(this).data('id');
    if (!confirm('Delete this summary question?')) return;
    summaryQuestions = summaryQuestions.filter(s=>s.id!=id);
    persistAll();
    renderSummaryQuestionsList();
  });
  $(document).on('click', '.btn-edit-summary-q', function(){
    const id = $(this).data('id');
    const q = summaryQuestions.find(s=>s.id==id);
    if (!q) return;
    $('#summary-q-id').val(q.id);
    $('#summary-q-text').val(q.text);
    $('#summary-q-text').focus();
  });

  // ---------- Report: Summary Questions Report ----------
  function buildSummaryReport(from, to){
    const dates = Object.keys(dailySummaries).sort();
    const filteredDates = dates.filter(d => {
      if (from && d < from) return false;
      if (to && d > to) return false;
      return true;
    });

    const qMap = {};
    summaryQuestions.forEach(q => { qMap[q.id] = { qId: q.id, text: q.text, Yes:0, No:0, NA:0, total:0 }; });

    filteredDates.forEach(d => {
      const s = dailySummaries[d];
      if (!s || !s.answers) return;
      s.answers.forEach(a => {
        if (!qMap[a.qId]){
          qMap[a.qId] = { qId: a.qId, text: '(deleted question)', Yes:0, No:0, NA:0, total:0 };
        }
        const ans = a.answer || 'NA';
        qMap[a.qId][ans] = (qMap[a.qId][ans]||0) + 1;
        qMap[a.qId].total++;
      });
    });

    const container = $('#summary-report-container').empty();
    const keys = Object.keys(qMap);
    if (!keys.length){
      container.html('<div class="alert alert-info">No summary questions found. Add some in Configuration → Manage Summary Questions.</div>');
      return;
    }

    const tbl = $(`<div class="table-responsive"><table class="table table-bordered"><thead><tr><th>Question</th><th>Yes (count)</th><th>No (count)</th><th>NA (count)</th><th>Total</th><th>Yes%</th><th>No%</th><th>NA%</th><th>Actions</th></tr></thead><tbody></tbody></table></div>`);
    const tbody = tbl.find('tbody');

    Object.values(qMap).forEach(qs => {
      const total = qs.total || 0;
      const yesPct = total ? ((qs.Yes/total)*100).toFixed(1) : '0.0';
      const noPct = total ? ((qs.No/total)*100).toFixed(1) : '0.0';
      const naPct = total ? ((qs.NA/total)*100).toFixed(1) : '0.0';
      tbody.append(`<tr>
        <td>${escapeHtml(qs.text)}</td>
        <td>${qs.Yes}</td>
        <td>${qs.No}</td>
        <td>${qs.NA}</td>
        <td>${total}</td>
        <td>${yesPct}%</td>
        <td>${noPct}%</td>
        <td>${naPct}%</td>
        <td><button class="btn btn-sm btn-info view-question-responses" data-qid="${qs.qId}">View</button></td>
      </tr>`);
    });

    container.append(tbl);
  }

  $(document).on('click', '.view-question-responses', function(){
    const qid = $(this).data('qid');
    const from = $('#summary-report-from').val() || null;
    const to = $('#summary-report-to').val() || null;
    const rows = [];
    Object.keys(dailySummaries).sort().forEach(d => {
      if (from && d < from) return;
      if (to && d > to) return;
      const s = dailySummaries[d];
      if (!s || !s.answers) return;
      const a = s.answers.find(x=>x.qId==qid);
      if (a) rows.push({ date: d, answer: a.answer, comment: a.comment || '' });
    });
    let html = `<h6 class="mb-2">Responses (${rows.length})</h6>`;
    if (!rows.length) html += '<div class="alert alert-info">No responses found for this question in the selected range.</div>';
    else {
      html += '<div class="list-group">';
      rows.forEach(r => {
        html += `<div class="list-group-item"><div class="d-flex justify-content-between"><div><strong>${r.date}</strong></div><div><span class="badge ${r.answer==='Yes'?'bg-success':r.answer==='No'?'bg-danger':'bg-secondary'}">${r.answer}</span></div></div>${r.comment?`<div class="mt-1 small text-muted">${escapeHtml(r.comment)}</div>`:''}</div>`;
      });
      html += '</div>';
    }
    $('#summaryModalTitle').text('Responses for Question');
    $('#summary-modal-body').html(html);
    $('#save-today-summary').hide();
    $('#delete-today-summary').hide();
    bootstrap.Modal.getOrCreateInstance(document.getElementById('summaryModal')).show();
    $('#summaryModal').on('hidden.bs.modal.temp', function(){ $('#save-today-summary').show(); $('#delete-today-summary').show(); $('#summaryModalTitle').text('Daily Summary'); $('#summaryModal').off('hidden.bs.modal.temp'); });
  });

  // ---------- Event bindings ----------
  $('#date-picker').val(todayISO());

  $('#login-form').on('submit', function(e){
    e.preventDefault();
    const u = $('#username').val().trim(), p = $('#password').val();
    if (u === 'local' && p === 'local1234'){
      $('#login-page').hide();
      $('#main-app').show();
      populateScenarioDropdown();
      renderDailyScenarios();
      renderConfigurations();
      renderReport();
    } else {
      $('#login-error').text('Invalid username or password').show();
    }
  });

  $('#add-new-scenario').on('click', function(){
    $('#scenario-form')[0].reset();
    $('#daily-scenario-id').val('');
    currentImages = [];
    $('#image-preview-container').empty();
    $('#daily-rules-container').html('<div class="alert alert-info text-center">Select a scenario to load rules.</div>');
    populateScenarioDropdown();
    $('#addScenarioTitle').text('Add Daily Scenario');
    bootstrap.Modal.getOrCreateInstance(document.getElementById('addScenarioModal')).show();
  });

  $('#scenario-select').on('change', function(){
    const cfgId = $(this).val();
    $('#daily-rules-container').empty();
    if (!cfgId){
      $('#daily-rules-container').html('<div class="alert alert-info text-center">Select a scenario to load rules.</div>');
      return;
    }
    const rules = JSON.parse(localStorage.getItem('rules_' + cfgId) || '[]');
    if (!rules.length){
      $('#daily-rules-container').html('<div class="alert alert-warning text-center">No rules configured for this scenario. Use Manage Rules in Configuration to add.</div>');
      return;
    }
    rules.forEach(r => {
      $('#daily-rules-container').append(`
        <div class="card p-2 mb-2 rule-item" data-rule-id="${r.id}">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <h6 class="mb-1">${escapeHtml(r.name)}</h6>
              <small class="text-muted">${escapeHtml(r.condition || '')}</small>
            </div>
          </div>
          <div class="row g-2 mt-2">
            <div class="col-md-3">
              <select class="form-select status-select">
                <option value="pass">Pass</option>
                <option value="fail">Fail</option>
              </select>
            </div>
            <div class="col-md-9">
              <textarea class="form-control comment-input" rows="1" placeholder="Comment"></textarea>
            </div>
          </div>
        </div>
      `);
    });
  });

  $('#image-upload').on('change', function(){
    const files = this.files;
    if (!files) return;
    Array.from(files).forEach(file=>{
      const reader = new FileReader();
      reader.onload = function(e){
        currentImages.push(e.target.result);
        renderImagePreviews();
      };
      reader.readAsDataURL(file);
    });
    $(this).val('');
  });
  function renderImagePreviews(){
    const cont = $('#image-preview-container').empty();
    currentImages.forEach((img,i)=>{
      const el = $(`
        <div class="position-relative image-preview-item">
          <img src="${img}" alt="preview" />
          <span class="remove-btn" data-index="${i}">&times;</span>
        </div>
      `);
      cont.append(el);
    });
  }
  $(document).on('click', '.remove-btn', function(){ const idx = $(this).data('index'); currentImages.splice(idx,1); renderImagePreviews(); });

  $('#save-daily-scenario').on('click', function(){
    const id = $('#daily-scenario-id').val() || Date.now().toString();
    const cfgId = $('#scenario-select').val();
    const date = $('#date-picker').val();
    const status = $('#status-select').val();
    const explanation = $('#explanation-input').val();

    if (!cfgId){ alert('Select a scenario configuration'); return; }
    if (!date){ alert('Select a date'); return; }
    if (!status){ alert('Select a status'); return; }

    const rules = [];
    $('#daily-rules-container .rule-item').each(function(){
      const ruleId = $(this).data('rule-id');
      const ruleStatus = $(this).find('.status-select').val();
      const comment = $(this).find('.comment-input').val();
      rules.push({ id: ruleId, status: ruleStatus, comment });
    });

    const scenarioObj = { id, configId: cfgId, status, explanation, rules, images: currentImages.slice() };

    Object.keys(dailyScenarios).forEach(d => {
      dailyScenarios[d] = (dailyScenarios[d] || []).filter(s => s.id !== id);
      if (!dailyScenarios[d].length) delete dailyScenarios[d];
    });

    if (!dailyScenarios[date]) dailyScenarios[date] = [];
    dailyScenarios[date].push(scenarioObj);

    persistAll();

    bootstrap.Modal.getOrCreateInstance(document.getElementById('addScenarioModal')).hide();
    $('#scenario-form')[0].reset();
    $('#image-preview-container').empty();
    currentImages = [];
    $('#daily-scenario-id').val('');
    renderDailyScenarios();
    renderReport();
  });

  $(document).on('click', '.btn-edit', function(){
    const id = $(this).data('id');
    let found = null, foundDate = null;
    Object.keys(dailyScenarios).forEach(d=>{
      dailyScenarios[d].forEach(s=>{ if (s.id == id){ found = s; foundDate = d; }});
    });
    if (!found) return alert('Scenario not found');

    $('#daily-scenario-id').val(found.id);
    $('#status-select').val(found.status);
    $('#explanation-input').val(found.explanation);
    currentImages = (found.images||[]).slice();
    renderImagePreviews();

    populateScenarioDropdown();
    $('#scenario-select').val(found.configId).trigger('change');

    const defs = JSON.parse(localStorage.getItem('rules_' + found.configId) || '[]');
    const container = $('#daily-rules-container').empty();
    if (!defs.length){
      container.html('<div class="alert alert-warning text-center">No rules configured for this scenario config.</div>');
    } else {
      defs.forEach(def => {
        const saved = (found.rules||[]).find(r=>r.id==def.id) || { status:'pass', comment:'' };
        container.append(`
          <div class="card p-2 mb-2 rule-item" data-rule-id="${def.id}">
            <h6 class="mb-1">${escapeHtml(def.name)}</h6>
            <p class="small text-muted">Condition: ${escapeHtml(def.condition||'')}</p>
            <div class="row g-2">
              <div class="col-md-3"><select class="form-select status-select"><option value="pass" ${saved.status==='pass'?'selected':''}>Pass</option><option value="fail" ${saved.status==='fail'?'selected':''}>Fail</option></select></div>
              <div class="col-md-9"><textarea class="form-control comment-input" rows="1">${escapeHtml(saved.comment||'')}</textarea></div>
            </div>
          </div>
        `);
      });
    }

    $('#addScenarioTitle').text('Edit Daily Scenario');
    bootstrap.Modal.getOrCreateInstance(document.getElementById('addScenarioModal')).show();
  });

  $(document).on('click', '.btn-view', function(){
    const id = $(this).data('id');
    let found = null, foundDate = null;
    Object.keys(dailyScenarios).forEach(d=>{
      dailyScenarios[d].forEach(s=>{ if (s.id == id){ found = s; foundDate = d; }});
    });
    if (!found) return alert('Scenario not found');

    const cfg = configurations.find(c=>c.id==found.configId) || { title:'Unknown' };
    const defs = JSON.parse(localStorage.getItem('rules_' + found.configId) || '[]');
    let rulesHtml = '<div class="alert alert-info">No rules configured.</div>';
    if (found.rules && found.rules.length && defs.length){
      rulesHtml = '<ul class="list-group">';
      found.rules.forEach(r=>{
        const def = defs.find(d=>d.id==r.id) || {};
        rulesHtml += `<li class="list-group-item"><h6 class="mb-1">${escapeHtml(def.name || 'Unknown')}</h6><p class="mb-1"><strong>Status:</strong> <span class="badge ${r.status==='pass'?'bg-success':'bg-danger'}">${(r.status||'').toUpperCase()}</span></p>${r.comment?`<p class="mb-0"><strong>Comment:</strong> ${escapeHtml(r.comment)}</p>`:''}</li>`;
      });
      rulesHtml += '</ul>';
    }

    const imagesHtml = (found.images || []).length ?
      (found.images.map((img,i)=>`
        <div class="col-md-4 mb-3">
        <a href="${img}" target="_blank">
          <div class="zoom-wrap"><img src="${img}" class="zoom-img" data-index="${i}" /></div>
        </a>
        </div>`).join(''))
      : '<div class="col"><p>No images uploaded.</p></div>';

    $('#view-scenario-body').html(`
      <p><strong>Scenario Title:</strong> ${escapeHtml(cfg.title)}</p>
      <p><strong>Date:</strong> ${foundDate}</p>
      <p><strong>Status:</strong> <span class="badge ${found.status==='pass'?'bg-success':(found.status==='fail'?'bg-danger':'bg-warning')}">${(found.status||'').toUpperCase()}</span></p>
      <p><strong>Explanation:</strong> ${escapeHtml(found.explanation||'N/A')}</p>
      <hr />
      <h6>Rules:</h6>
      ${rulesHtml}
      <hr />
      <h6>Images:</h6>
      <div class="row">${imagesHtml}</div>
    `);

    manageRulesForConfig = found.configId;
    $('#rules-scenario-title').text( configurations.find(c=>c.id==found.configId)?.title || '' );

    bootstrap.Modal.getOrCreateInstance(document.getElementById('viewScenarioModal')).show();
    setTimeout(()=>{ initPanZoom('.zoom-img'); }, 100);
  });

  $(document).on('click', '.btn-delete', function(){
    const id = $(this).data('id');
    if (!confirm('Delete this scenario?')) return;
    Object.keys(dailyScenarios).forEach(d=>{
      dailyScenarios[d] = (dailyScenarios[d]||[]).filter(s=>s.id!=id);
      if (!dailyScenarios[d].length) delete dailyScenarios[d];
    });
    persistAll();
    renderDailyScenarios();
    renderReport();
  });

  $(document).on('click', '.btn-view-report', function () {
    const id = $(this).data('id');
    let found = null, foundDate = null;
    Object.keys(dailyScenarios).forEach(d => {
      (dailyScenarios[d] || []).forEach(s => {
        if (String(s.id) === String(id)) { found = s; foundDate = d; }
      });
    });
    if (!found) return alert('Scenario not found');

    const cfg  = configurations.find(c => c.id === found.configId) || { title: 'Unknown' };
    const defs = JSON.parse(localStorage.getItem('rules_' + found.configId) || '[]');

    let rulesHtml = '<div class="alert alert-info">No rules configured.</div>';
    if (found.rules && found.rules.length && defs.length) {
      rulesHtml = '<ul class="list-group">';
      found.rules.forEach(r => {
        const def = defs.find(d => d.id === r.id) || {};
        rulesHtml += `<li class="list-group-item">
                        <h6 class="mb-1">${escapeHtml(def.name || 'Unknown')}</h6>
                        <p class="mb-1"><strong>Status:</strong>
                          <span class="badge ${r.status==='pass'?'bg-success':'bg-danger'}">${(r.status||'').toUpperCase()}</span>
                        </p>
                        ${r.comment ? `<p class="mb-0"><strong>Comment:</strong> ${escapeHtml(r.comment)}</p>` : ''}
                      </li>`;
      });
      rulesHtml += '</ul>';
    }

    const imagesHtml = (found.images || []).length
      ? found.images.map((img,i)=>`
          <div class="col-md-4 mb-3">
            <div class="zoom-wrap">
              <img src="${img}" class="zoom-img safe-zoom" data-index="${i}" />
            </div>
          </div>`).join('')
      : '<div class="col"><p>No images uploaded.</p></div>';

    $('#view-scenario-body').html(`
      <p><strong>Scenario Title:</strong> ${escapeHtml(cfg.title)}</p>
      <p><strong>Date:</strong> ${foundDate}</p>
      <p><strong>Status:</strong>
         <span class="badge ${found.status==='pass'?'bg-success':(found.status==='fail'?'bg-danger':'bg-warning')}">
           ${(found.status||'').toUpperCase()}
         </span>
      </p>
      <p><strong>Explanation:</strong> ${escapeHtml(found.explanation||'N/A')}</p>
      <hr><h6>Rules:</h6>${rulesHtml}
      <hr><h6>Images:</h6><div class="row">${imagesHtml}</div>
    `);

    bootstrap.Modal.getOrCreateInstance(document.getElementById('viewScenarioModal')).show();
    setTimeout(()=>{ initPanZoom('.safe-zoom'); },100);
  });

  // Config CRUD
  $('#open-add-config').on('click', function(){
    $('#config-form')[0].reset();
    $('#config-id').val('');
    $('#configModalTitle').text('Add Configuration');
    bootstrap.Modal.getOrCreateInstance(document.getElementById('addConfigModal')).show();
  });

  $('#save-config').on('click', function(){
    const id = $('#config-id').val() || Date.now().toString();
    const title = $('#config-title').val().trim();
    if (!title) return alert('Enter title');
    const description = $('#config-description').val();
    const entry = $('#entry-point').val();
    const exit = $('#exit-point').val();
    const idx = configurations.findIndex(c=>c.id==id);
    const cfg = { id, title, description, entryPoint: entry, exitPoint: exit };
    if (idx >= 0) configurations[idx] = cfg; else configurations.push(cfg);
    if (!localStorage.getItem('rules_' + id)) localStorage.setItem('rules_' + id, JSON.stringify([]));
    persistAll();
    renderConfigurations();
    populateScenarioDropdown();
    bootstrap.Modal.getOrCreateInstance(document.getElementById('addConfigModal')).hide();
  });

  $(document).on('click', '.btn-view-config', function(){
    const id = $(this).data('id');
    const cfg = configurations.find(c=>c.id==id);
    if (!cfg) return alert('Config not found');
    const rules = JSON.parse(localStorage.getItem('rules_' + id) || '[]');
    const rulesHtml = rules.length ? rules.map(r=>`<li class="list-group-item"><h6>${escapeHtml(r.name)}</h6><small class="text-muted">${escapeHtml(r.condition||'')}</small></li>`).join('') : '<div class="alert alert-info">No rules configured.</div>';
    $('#view-config-body').html(`<p><strong>Title:</strong> ${escapeHtml(cfg.title)}</p><p><strong>Description:</strong> ${escapeHtml(cfg.description||'')}</p><p><strong>Entry:</strong> ${escapeHtml(cfg.entryPoint||'N/A')} | <strong>Exit:</strong> ${escapeHtml(cfg.exitPoint||'N/A')}</p><hr><h6>Rules:</h6><ul class="list-group">${rulesHtml}</ul>`);
    bootstrap.Modal.getOrCreateInstance(document.getElementById('viewConfigModal')).show();
  });

  $(document).on('click', '.btn-edit-config', function(){
    const id = $(this).data('id');
    const cfg = configurations.find(c=>c.id==id);
    if (!cfg) return;
    $('#config-id').val(cfg.id);
    $('#config-title').val(cfg.title);
    $('#config-description').val(cfg.description);
    $('#entry-point').val(cfg.entryPoint);
    $('#exit-point').val(cfg.exitPoint);
    $('#configModalTitle').text('Edit Configuration');
    bootstrap.Modal.getOrCreateInstance(document.getElementById('addConfigModal')).show();
  });

  $(document).on('click', '.btn-delete-config', function(){
    const id = $(this).data('id');
    if (!confirm('Delete configuration and related scenarios?')) return;
    configurations = configurations.filter(c=>c.id!=id);
    Object.keys(dailyScenarios).forEach(d=>{
      dailyScenarios[d] = (dailyScenarios[d]||[]).filter(s=>s.configId!=id);
      if (!dailyScenarios[d].length) delete dailyScenarios[d];
    });
    localStorage.removeItem('rules_' + id);
    persistAll();
    renderConfigurations();
    renderDailyScenarios();
    renderReport();
    populateScenarioDropdown();
  });

  $(document).on('click', '.btn-copy-config', function(){
    const id = $(this).data('id');
    const cfg = configurations.find(c=>c.id==id);
    if (!cfg) return;
    const newCfg = JSON.parse(JSON.stringify(cfg));
    newCfg.id = Date.now().toString();
    newCfg.title = cfg.title + ' (Copy)';
    configurations.push(newCfg);
    const rules = JSON.parse(localStorage.getItem('rules_' + id) || '[]');
    localStorage.setItem('rules_' + newCfg.id, JSON.stringify(rules));
    persistAll();
    renderConfigurations();
    populateScenarioDropdown();
  });

  $('#manage-config-rules').on('click', function(){
    let cfgId = $('#config-id').val();
    if(!cfgId){
      cfgId = Date.now().toString();
      $('#config-id').val(cfgId);
      const title = $('#config-title').val().trim() || 'Untitled';
      const description = $('#config-description').val() || '';
      const entry = $('#entry-point').val() || '';
      const exit = $('#exit-point').val() || '';
      const cfg = { id: cfgId, title, description, entryPoint: entry, exitPoint: exit };
      configurations.push(cfg);
      if (!localStorage.getItem('rules_' + cfgId)) localStorage.setItem('rules_' + cfgId, JSON.stringify([]));
      persistAll();
      renderConfigurations();
      populateScenarioDropdown();
    }
    manageRulesForConfig = cfgId;
    $('#rules-scenario-title').text($('#config-title').val() || 'Untitled');
    const rules = JSON.parse(localStorage.getItem('rules_' + cfgId) || '[]');
    renderRulesList(rules);
    bootstrap.Modal.getOrCreateInstance(document.getElementById('addConfigModal')).hide();
    bootstrap.Modal.getOrCreateInstance(document.getElementById('manageRulesModal')).show();
  });

  $('#view-manage-rules').on('click', function(){
    if (!manageRulesForConfig) return alert('No configuration context for rules');
    $('#rules-scenario-title').text( configurations.find(c=>c.id==manageRulesForConfig)?.title || '');
    const rules = JSON.parse(localStorage.getItem('rules_' + manageRulesForConfig) || '[]');
    renderRulesList(rules);
    bootstrap.Modal.getOrCreateInstance(document.getElementById('viewScenarioModal')).hide();
    bootstrap.Modal.getOrCreateInstance(document.getElementById('manageRulesModal')).show();
  });

  function renderRulesList(rules){
    const list = $('#rules-list').empty();
    if (!rules.length) list.html('<div class="alert alert-info">No rules yet. Add one below.</div>');
    rules.forEach(r => {
      list.append(`<li class="list-group-item d-flex justify-content-between align-items-center" data-id="${r.id}"><div><h6 class="mb-0">${escapeHtml(r.name)}</h6><small class="text-muted">${escapeHtml(r.condition||'')}</small></div><button class="btn btn-danger btn-sm remove-rule" data-id="${r.id}"><i class="fas fa-times"></i></button></li>`);
    });
  }

  $('#add-rule-btn').on('click', function(){
    const name = $('#rule-name').val().trim();
    if (!name) return alert('Enter rule name');
    const condition = $('#rule-condition').val();
    const id = Date.now().toString();
    const key = 'rules_' + manageRulesForConfig;
    const rules = JSON.parse(localStorage.getItem(key) || '[]');
    rules.push({ id, name, condition });
    localStorage.setItem(key, JSON.stringify(rules));
    $('#rule-name').val(''); $('#rule-condition').val('');
    renderRulesList(rules);
  });

  $(document).on('click', '.remove-rule', function(){
    const id = $(this).data('id');
    const key = 'rules_' + manageRulesForConfig;
    let rules = JSON.parse(localStorage.getItem(key) || '[]');
    rules = rules.filter(r=>r.id!=id);
    localStorage.setItem(key, JSON.stringify(rules));
    renderRulesList(rules);
  });

  $('#manageRulesModal').on('hidden.bs.modal', function(){
    populateScenarioDropdown();
    renderConfigurations();
    if ($('#config-title').val() || $('#config-id').val()) {
      bootstrap.Modal.getOrCreateInstance(document.getElementById('addConfigModal')).show();
    } else {
      if ($('#addScenarioModal')) bootstrap.Modal.getOrCreateInstance(document.getElementById('addScenarioModal')).show();
    }
  });

  $('#filter-report').on('click', function(){
    const from = $('#report-from').val() || null;
    const to = $('#report-to').val() || null;
    renderReport(from,to);
  });

  $('#refresh-daily').on('click', function(){ renderDailyScenarios(); });
  $('#date-picker').on('change', function(){ renderDailyScenarios(); });

  // Summary modal open & actions
  $('#open-summary-btn').on('click', function(){
    const date = $('#date-picker').val() || todayISO();
    buildSummaryModal(date);
    $('#summaryModalTitle').text('Daily Summary');
    $('#save-today-summary').show();
    $('#delete-today-summary').show();
    bootstrap.Modal.getOrCreateInstance(document.getElementById('summaryModal')).show();
  });

  $('#save-today-summary').on('click', function(){
    const date = $('#date-picker').val() || todayISO();
    saveSummaryForDate(date);
  });

  $('#delete-today-summary').on('click', function(){
    const date = $('#date-picker').val() || todayISO();
    deleteSummaryForDate(date);
  });

  $('#open-manage-summary-questions').on('click', function(){
    renderSummaryQuestionsList();
    $('#summary-q-id').val(''); $('#summary-q-text').val('');
    bootstrap.Modal.getOrCreateInstance(document.getElementById('manageSummaryQuestionsModal')).show();
  });

  $('#filter-summary-report').on('click', function(){
    const from = $('#summary-report-from').val() || null;
    const to = $('#summary-report-to').val() || null;
    buildSummaryReport(from, to);
  });

  // pan/zoom
  function initPanZoom(selector) {
  // Robust pan/zoom using Pointer events with multi-touch pinch support.
  // Works on desktop (wheel/drag/dblclick) and mobile (pinch/drag/double-tap).
  document.querySelectorAll(selector).forEach(img => {
    if (img._pzInitialized) return;
    img._pzInitialized = true;

    // initial state
    let scale = 1;
    const MIN_SCALE = 1;
    const MAX_SCALE = 4;
    let translate = { x: 0, y: 0 };

    // pointer tracking for pan & pinch
    const pointers = new Map();
    let lastTouchDistance = null;
    let isDragging = false;
    let lastPointerPos = null;

    // helper to apply transform
    function applyTransform() {
      img.style.transform = `translate(${translate.x}px, ${translate.y}px) scale(${scale})`;
    }

    // reset to fit
    function resetFit(animate=true) {
      scale = 1;
      translate = { x: 0, y: 0 };
      if (animate) img.style.transition = 'transform 180ms ease';
      applyTransform();
      setTimeout(()=> img.style.transition = '', 200);
    }

    // clamp translate so image doesn't go way off screen (simple clamp)
    function clampTranslate() {
      // compute visible sizes
      const rect = img.getBoundingClientRect();
      // image displayed size after scale
      const iw = rect.width;
      const ih = rect.height;

      // container allowable overflow (a margin)
      const maxX = Math.max(0, (iw * (scale) - rect.width) / 2 + 10);
      const maxY = Math.max(0, (ih * (scale) - rect.height) / 2 + 10);

      // simple clamping
      translate.x = Math.max(-maxX, Math.min(maxX, translate.x));
      translate.y = Math.max(-maxY, Math.min(maxY, translate.y));
    }

    // wheel zoom (desktop)
    function onWheel(e) {
      try {
        e.preventDefault();
        const delta = -e.deltaY;
        const zoomFactor = delta > 0 ? 1.08 : 0.93; // small steps
        const newScale = Math.max(MIN_SCALE, Math.min(MAX_SCALE, scale * zoomFactor));
        // zoom toward mouse pointer: compute offset
        const rect = img.getBoundingClientRect();
        const cx = e.clientX - rect.left;
        const cy = e.clientY - rect.top;
        // transform to image coordinates
        const relX = (cx - rect.width/2 - translate.x) / scale;
        const relY = (cy - rect.height/2 - translate.y) / scale;
        // update scale
        const prevScale = scale;
        scale = newScale;
        // update translate so the point under cursor remains under cursor
        translate.x -= (relX * (scale - prevScale));
        translate.y -= (relY * (scale - prevScale));
        clampTranslate();
        applyTransform();
      } catch (err) { console.warn('wheel zoom error', err); }
    }

    function getDistance(p1, p2) {
      const dx = p2.x - p1.x;
      const dy = p2.y - p1.y;
      return Math.hypot(dx, dy);
    }

    function pointerDown(e) {
      try {
        img.setPointerCapture?.(e.pointerId);
        pointers.set(e.pointerId, { x: e.clientX, y: e.clientY });
        lastPointerPos = { x: e.clientX, y: e.clientY };

        if (pointers.size === 1) {
          isDragging = true;
          img.classList.add('dragging');
        } else if (pointers.size === 2) {
          // start pinch
          const pts = Array.from(pointers.values());
          lastTouchDistance = getDistance(pts[0], pts[1]);
        }
      } catch (err) { console.warn('pointerDown err', err); }
    }

    function pointerMove(e) {
      try {
        if (!pointers.has(e.pointerId)) return;
        const prev = pointers.get(e.pointerId);
        const curr = { x: e.clientX, y: e.clientY };
        pointers.set(e.pointerId, curr);

        if (pointers.size === 1 && isDragging) {
          // simple pan
          const dx = curr.x - prev.x;
          const dy = curr.y - prev.y;
          translate.x += dx;
          translate.y += dy;
          clampTranslate();
          applyTransform();
        } else if (pointers.size === 2) {
          // pinch to zoom
          const pts = Array.from(pointers.values());
          const dist = getDistance(pts[0], pts[1]);
          if (lastTouchDistance) {
            const factor = dist / lastTouchDistance;
            const newScale = Math.max(MIN_SCALE, Math.min(MAX_SCALE, scale * factor));
            // center between two pointers
            const rect = img.getBoundingClientRect();
            const center = { x: (pts[0].x + pts[1].x)/2 - rect.left, y: (pts[0].y + pts[1].y)/2 - rect.top };
            const relX = (center.x - rect.width/2 - translate.x) / scale;
            const relY = (center.y - rect.height/2 - translate.y) / scale;
            const prevScale = scale;
            scale = newScale;
            translate.x -= (relX * (scale - prevScale));
            translate.y -= (relY * (scale - prevScale));
            clampTranslate();
            applyTransform();
          }
          lastTouchDistance = dist;
        }
      } catch (err) { console.warn('pointerMove err', err); }
    }

    function pointerUp(e) {
      try {
        pointers.delete(e.pointerId);
        lastPointerPos = null;
        if (pointers.size < 2) lastTouchDistance = null;
        if (pointers.size === 0) {
          isDragging = false;
          img.classList.remove('dragging');
        }
      } catch (err) { console.warn('pointerUp err', err); }
    }

    // custom double-tap / double-click toggle (robust)
    let lastTap = 0;
    function onPointerTap(e) {
      try {
        // treat only primary button/touch
        if (e.pointerType === 'mouse' && e.button !== 0) return;
        const now = Date.now();
        const gap = now - lastTap;
        lastTap = now;
        if (gap < 350) { // double-tap/dblclick detected
          // toggle between fit and safe zoom
          if (scale > 1.05) {
            resetFit(true);
          } else {
            // zoom to 2x centered at tapped position
            const rect = img.getBoundingClientRect();
            const cx = e.clientX - rect.left;
            const cy = e.clientY - rect.top;
            const targetScale = 2;
            const relX = (cx - rect.width/2 - translate.x) / scale;
            const relY = (cy - rect.height/2 - translate.y) / scale;
            const prevScale = scale;
            scale = Math.max(MIN_SCALE, Math.min(MAX_SCALE, targetScale));
            translate.x -= (relX * (scale - prevScale));
            translate.y -= (relY * (scale - prevScale));
            clampTranslate();
            applyTransform();
          }
        }
      } catch (err) { console.warn('tap handler err', err); }
    }

    // touch-friendly tap binding: pointerdown + small movement = tap
    let pointerDownTime = 0;
    let pointerDownPos = null;
    function onPointerDownForTap(e) {
      pointerDownTime = Date.now();
      pointerDownPos = { x: e.clientX, y: e.clientY };
    }
    function onPointerUpForTap(e) {
      const dt = Date.now() - pointerDownTime;
      const dx = Math.abs(e.clientX - (pointerDownPos?.x || 0));
      const dy = Math.abs(e.clientY - (pointerDownPos?.y || 0));
      if (dt < 400 && dx < 8 && dy < 8) {
        onPointerTap(e);
      }
      pointerDownPos = null;
    }

    // add listeners
    img.addEventListener('pointerdown', function(e){ pointerDown(e); onPointerDownForTap(e); });
    img.addEventListener('pointermove', pointerMove);
    img.addEventListener('pointerup', function(e){ pointerUp(e); onPointerUpForTap(e); });
    img.addEventListener('pointercancel', pointerUp);
    img.addEventListener('pointerout', () => {}); // no-op (prevents some Safari issues)

    // wheel zoom
    img.addEventListener('wheel', onWheel, { passive: false });

    // safety: double-click native -> prevent default to avoid conflict with pointer capture crashes
    img.addEventListener('dblclick', function(e){ e.preventDefault(); });

    // Reset when modal is closed to avoid sticky transforms
    $(document).on('hidden.bs.modal', '#viewScenarioModal', function() {
      try { resetFit(false); } catch(e){/*ignore*/ }
    });

    // ensure initial placement is reset
    resetFit(false);
  });
}


  // Init
  (function init(){
    populateScenarioDropdown();
    renderDailyScenarios();
    renderConfigurations();
    renderReport();
    const t = new Date(); const to = t.toISOString().slice(0,10);
    t.setDate(t.getDate()-7); const from = t.toISOString().slice(0,10);
    $('#summary-report-from').val(from); $('#summary-report-to').val(to);
    $('#report-from').val(from); $('#report-to').val(to);
    buildSummaryReport(from, to);
  })();

  // Persist on storage event (other tabs)
  window.addEventListener('storage', function(){
    dailyScenarios = JSON.parse(localStorage.getItem('dailyScenarios') || '{}');
    configurations = JSON.parse(localStorage.getItem('configurations') || '[]');
    summaryQuestions = JSON.parse(localStorage.getItem('summaryQuestions') || '[]');
    dailySummaries = JSON.parse(localStorage.getItem('dailySummaries') || '{}');
    populateScenarioDropdown();
    renderDailyScenarios();
    renderConfigurations();
    renderReport();
  });

});
</script>
</body>
</html>
