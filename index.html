<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Stock Scenario Manager — Full Enhanced</title>

<!-- Fonts & Icons -->
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet">

<!-- Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
:root{
  --primary: #4f46e5;   /* Indigo for primary actions */
  --primary-light: #6366f1;
  --accent:  #f43f5e;   /* Vibrant pink accent */
  --bg:      #f3f4f6;   /* Soft gray background */
  --card:    #ffffff;
  --success: #22c55e;
  --danger:  #ef4444;
  --warning: #f59e0b;
  --muted:   #6b7280;
}
body{
  font-family: 'Poppins', sans-serif;
  background: var(--bg);
  color: #111827;
}
.container{max-width:1200px;margin-top:28px}
h1{color:var(--primary);font-weight:700}
.card{
  border-radius: 16px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.08);
  border: none;
  transition: transform 0.2s;
}
.card:hover{ transform: translateY(-2px); }
.nav-tabs .nav-link{
  border-radius: 30px;
  margin: 0 6px;
  background: transparent;
  color: var(--muted);
  font-weight: 600;
}
.nav-tabs .nav-link.active{
  background: var(--primary);
  color: #fff;
}
.tab-content{background:var(--card);padding:20px;border-radius:12px}
.btn-primary{
  background: linear-gradient(135deg, var(--primary), var(--primary-light));
  border: none;
  border-radius: 30px;
  font-weight: 600;
  transition: background 0.3s;
}
.btn-primary:hover{
  background: linear-gradient(135deg, var(--primary-light), var(--primary));
}
.form-control,.form-select{border-radius:8px}
.scenario-card{display:flex;gap:16px;align-items:center;padding:14px;border-radius:12px;background:#fff;border:1px solid #eee}
.scenario-card img{width:120px;height:80px;object-fit:cover;border-radius:8px}
.scenario-status{font-weight:700;padding:6px 10px;border-radius:8px;color:#fff;font-size:.8rem;text-transform:uppercase}
.pass{background:var(--success)}.fail{background:var(--danger)}.not-produced{background:var(--warning)}
.image-preview-item img{width:80px;height:80px;object-fit:cover;border-radius:8px;border:1px solid #ddd}
.image-preview-item .remove-btn{position:absolute;top:-6px;right:-6px;background:var(--danger);color:#fff;border-radius:50%;width:22px;height:22px;display:flex;align-items:center;justify-content:center;font-size:12px;cursor:pointer}
/* === Modern Glassy Login Screen === */
.login-wrap {
  display: flex;
  justify-content: center;
  align-items: center;
  min-height: 100vh;

  /* Soft gradient overlay + background image */
  background: 
    linear-gradient(rgba(0,0,0,0.45), rgba(0,0,0,0.55)),
    url('https://source.unsplash.com/1600x900/?stock,finance,technology') center/cover no-repeat;
}

/* === Modern Orange & White Login Screen === */
.login-wrap {
  display: flex;
  justify-content: center;
  align-items: center;
  min-height: 100vh;

  /* Background image with a subtle dark overlay for contrast */
  background:
    linear-gradient(rgba(0,0,0,0.4), rgba(0,0,0,0.4)),
    url('https://source.unsplash.com/1600x900/?finance,stock,technology') center/cover no-repeat;
}

.login-container {
  width: 92%;
  max-width: 380px;
  padding: 40px 32px;

  /* Vibrant orange background with a soft white inner panel */
  background: linear-gradient(135deg, #ff9800, #ffb74d); /* orange gradient */
  border-radius: 20px;
  color: #fff;
  box-shadow: 0 12px 40px rgba(0,0,0,0.35);
  position: relative;
  overflow: hidden;
}

/* create a white inner inset “panel” */
.login-container::before {
  content: "";
  position: absolute;
  top: 12px;
  left: 12px;
  right: 12px;
  bottom: 12px;
  background: #ffffff;
  border-radius: 16px;
  z-index: 0;
}

.login-container h2,
.login-container p,
.login-container form {
  position: relative;
  z-index: 1;  /* keep content above the white inset */
  color: #ff6f00; /* dark orange text inside */
}

/* inputs with orange border */
.login-container .form-control {
  border-radius: 30px;
  padding: 0.75rem 1rem;
  border: 1px solid #ff9800;
  background: #fff;
  color: #333;
}
.login-container .form-control::placeholder { color: #999; }

.login-container .btn-primary {
  border-radius: 30px;
  font-weight: 600;
  background: linear-gradient(135deg, #ff9800, #ffb74d);
  border: none;
  color: #fff;
  padding: 0.75rem;
  transition: opacity 0.3s;
}
.login-container .btn-primary:hover {
  opacity: 0.9;
}

/* entrance keyframe */
@keyframes fadeUp {
  to { opacity: 1; transform: translateY(0); }
}

.zoom-wrap{overflow:hidden;border-radius:8px}
.zoom-img{max-width:100%;height:auto;touch-action:none;user-select:none;-webkit-user-drag:none}
.small-muted{color:var(--muted)}
.table-striped tbody tr{
  transition: background 0.2s;
}
.table-striped tbody tr:hover{
  background: rgba(79,70,229,0.05);
}
.badge-pass{background:var(--success);color:#fff}
.badge-fail{background:var(--danger);color:#fff}
.badge-not{background:var(--warning);color:#212529}
@media (max-width:767px){
  .scenario-card{flex-direction:row}
  .scenario-card img{width:90px;height:70px}
}
/* === START Mobile & Modal Enhancements === */
@media (max-width: 575px){
  .login-container{
    width: 90% !important;
    padding: 24px;
  }
  .scenario-card img{ width:80px; height:60px; }
  .scenario-card{ flex-direction:column; align-items:flex-start; }
}

/* === Modern, polished modal header === */
.modal-header{
  /* soft diagonal gradient for depth */
  background: linear-gradient(135deg, var(--primary-light), var(--primary));
  color: #fff;
  font-weight: 700;

  /* round the top corners perfectly */
  border-top-left-radius: 20px;
  border-top-right-radius: 20px;

  /* remove any default border that can create “cut” edges */
  border-bottom: none;

  /* add a subtle shadow for lift */
  box-shadow: 0 2px 6px rgba(0,0,0,0.15);

  /* optional: smooth inner padding */
  padding: 1rem 1.25rem;
}


/* better mobile tap targets */
.btn { min-height: 44px; }

/* make tables scroll on small screens */
.table-responsive { overflow-x: auto; }

</style>
</head>
<body>

<!-- LOGIN -->
<div id="login-page" class="login-wrap">
  <div class="login-container text-center">
    <h2 class="mb-2">Stock Scenario Manager</h2>
    <p class="mb-3">Login with Username & Password</p>
    <form id="login-form">
      <div class="mb-2"><input class="form-control" id="username" placeholder="Username" required></div>
      <div class="mb-2"><input type="password" class="form-control" id="password" placeholder="Password" required></div>
      <!-- Changed to theme primary (orange) -->
      <button class="btn btn-primary w-100 fw-bold" type="submit">Login</button>
      <div id="login-error" class="mt-3 small text-white" style="display:none"></div>
    </form>
  </div>
</div>

<!-- MAIN APP -->
<div id="main-app" class="container" style="display:none">
  <h1 class="text-center mb-4">Stock Scenario Manager</h1>

  <ul class="nav nav-tabs mb-4" id="tabs">
    <li class="nav-item"><button class="nav-link active" data-bs-target="#daily" data-bs-toggle="tab">Daily Scenario</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-target="#report" data-bs-toggle="tab">Report</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-target="#config" data-bs-toggle="tab">Configuration</button></li>
  </ul>

  <div class="tab-content">
    <!-- DAILY -->
    <div class="tab-pane fade show active" id="daily">
      <div class="row align-items-end mb-3">
        <div class="col-md-4">
          <label class="form-label fw-bold">Select Date</label>
          <input type="date" id="date-picker" class="form-control">
        </div>
        <div class="col-md-8 text-end">
          <button id="add-new-scenario" class="btn btn-primary"><i class="fas fa-plus-circle me-1"></i> Add Scenario</button>
          <button id="refresh-daily" class="btn btn-secondary"><i class="fas fa-sync me-1"></i> Refresh</button>
        </div>
      </div>
      <hr />
      <div id="scenario-cards-container">
        <div class="text-center small-muted p-5">
          <i class="fas fa-info-circle fa-2x mb-2"></i>
          <p>No scenarios found for this date. Click "Add Scenario" to start.</p>
        </div>
      </div>
    </div>

    <!-- REPORT -->
    <div class="tab-pane fade" id="report">
      <h4 class="mb-3">Scenario Report</h4>
      <div class="card p-3 mb-3">
        <div class="row g-2">
          <div class="col-md-4"><label class="form-label">From Date</label><input type="date" id="report-from" class="form-control"></div>
          <div class="col-md-4"><label class="form-label">To Date</label><input type="date" id="report-to" class="form-control"></div>
          <div class="col-md-4 d-flex align-items-end"><button id="filter-report" class="btn btn-primary w-100">Filter</button></div>
        </div>
      </div>

      <div id="report-summary" class="mb-3"></div>

      <div class="card">
        <div class="card-header fw-bold" style="background-color: var(--primary); color:white;">Detailed Report</div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-striped" id="report-table">
              <thead style="background-color: var(--primary); color:white;">
                <tr><th>Scenario Title</th><th>Date</th><th>Status</th><th>Rules Passed</th><th>Explanation</th><th>Actions</th></tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- CONFIG -->
    <div class="tab-pane fade" id="config">
      <div class="text-end mb-3">
        <button class="btn btn-success" id="open-add-config"><i class="fas fa-plus me-1"></i> Add New Configuration</button>
      </div>
      <div id="config-list"></div>
    </div>
  </div>
</div>

<!-- MODALS -->

<!-- Add/Edit Scenario Modal (Removed Manage Rules button as requested) -->
<div class="modal fade" id="addScenarioModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addScenarioTitle">Add Daily Scenario</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="scenario-form">
          <input type="hidden" id="daily-scenario-id" />
          <div class="mb-3">
            <label class="form-label">Scenario</label>
            <select id="scenario-select" class="form-select" required></select>
          </div>
          <div class="mb-3">
            <label class="form-label">Status</label>
            <select id="status-select" class="form-select" required>
              <option value="" disabled selected>Select Status</option>
              <option value="pass">Pass</option>
              <option value="fail">Fail</option>
              <option value="not-produced">Not Produced</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Explanation</label>
            <textarea id="explanation-input" class="form-control" rows="3"></textarea>
          </div>
          <div class="mb-3">
            <label class="form-label">Image Upload</label>
            <input id="image-upload" type="file" class="form-control" accept="image/*" multiple>
            <div id="image-preview-container" class="d-flex flex-wrap gap-2 mt-2"></div>
          </div>
          <hr />
          <div id="daily-rules-container">
            <div class="alert alert-info text-center">Select a scenario to load rules.</div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button id="save-daily-scenario" class="btn btn-primary">Save Scenario</button>
      </div>
    </div>
  </div>
</div>

<!-- View Scenario Modal -->
<div class="modal fade" id="viewScenarioModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Scenario Details</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="view-scenario-body"></div>
      <div class="modal-footer">
        <button id="view-manage-rules" class="btn btn-outline-primary d-none"><i class="fas fa-tasks me-1"></i> Manage Rules</button>
        <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Add/Edit Config Modal -->
<div class="modal fade" id="addConfigModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="configModalTitle">Add Configuration</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="config-form">
          <input type="hidden" id="config-id">
          <div class="mb-3">
            <label class="form-label">Scenario Title</label>
            <input id="config-title" class="form-control" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Description</label>
            <textarea id="config-description" class="form-control" rows="3"></textarea>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3"><label class="form-label">Entry Point</label><input id="entry-point" class="form-control"></div>
            <div class="col-md-6 mb-3"><label class="form-label">Exit Point</label><input id="exit-point" class="form-control"></div>
          </div>
          <div class="text-end">
            <button id="manage-config-rules" type="button" class="btn btn-outline-primary"><i class="fas fa-tasks me-1"></i> Manage Rules</button>
          </div>
        </form>
      </div>
      <div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">Close</button><button id="save-config" class="btn btn-primary">Save Configuration</button></div>
    </div>
  </div>
</div>

<!-- View Config Modal -->
<div class="modal fade" id="viewConfigModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg"><div class="modal-content">
    <div class="modal-header"><h5 class="modal-title">Configuration Details</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
    <div class="modal-body" id="view-config-body"></div>
    <div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">Close</button></div>
  </div></div>
</div>

<!-- Manage Rules Modal -->
<div class="modal fade" id="manageRulesModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg"><div class="modal-content">
    <div class="modal-header">
      <h5 class="modal-title">Manage Rules for <span id="rules-scenario-title" class="text-primary"></span></h5>
      <button class="btn-close" data-bs-dismiss="modal"></button>
    </div>
    <div class="modal-body">
      <form id="add-rule-form" class="row g-2 mb-3 align-items-end">
        <div class="col-md-6"><label class="form-label">Rule Name</label><input id="rule-name" class="form-control"></div>
        <div class="col-md-4"><label class="form-label">Condition</label><input id="rule-condition" class="form-control"></div>
        <div class="col-md-2"><button id="add-rule-btn" class="btn btn-success w-100" type="button"><i class="fas fa-plus-circle"></i></button></div>
      </form>

      <hr>
      <ul id="rules-list" class="list-group"></ul>
    </div>
    <div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">Done</button></div>
  </div></div>
</div>

<!-- jQuery & Bootstrap JS -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.min.js"></script>

<script>
/* Enhanced app logic based on your requests
   - Removed Manage Rules button from add/edit scenario modal
   - Manage Rules from config ensures config is saved first (fixes loss of rules)
   - Report shows scenario-wise grouped view and detailed table with orange header
   - Login button uses theme orange
   - UI improvements and color tweaks
*/

$(function(){
  // State
  let dailyScenarios = JSON.parse(localStorage.getItem('dailyScenarios') || '{}'); // {date: [scen..]}
  let configurations = JSON.parse(localStorage.getItem('configurations') || '[]'); // [config..]
  let currentImages = [];
  let manageRulesForConfig = null;

  // Helpers
  function persistData(){
    localStorage.setItem('dailyScenarios', JSON.stringify(dailyScenarios));
    localStorage.setItem('configurations', JSON.stringify(configurations));
  }
  function todayISO(){ return new Date().toISOString().slice(0,10); }
  function escapeHtml(s){ return String(s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

  // UI Populate
  function populateScenarioDropdown(){
    const sel = $('#scenario-select').empty();
    sel.append('<option value="" disabled selected>Select a Scenario</option>');
    configurations.forEach(c => sel.append(`<option value="${c.id}">${escapeHtml(c.title)}</option>`));
  }

  function renderDailyScenarios(){
    const date = $('#date-picker').val();
    const container = $('#scenario-cards-container').empty();
    const list = dailyScenarios[date] || [];
    if (!list.length){
      container.html('<div class="text-center small-muted p-5"><i class="fas fa-info-circle fa-2x mb-2"></i><p>No scenarios found for this date. Click "Add Scenario".</p></div>');
      return;
    }
    list.forEach(s => {
      const cfg = configurations.find(c=>c.id==s.configId) || { title:'Unknown' };
      const img = (s.images && s.images.length) ? s.images[0] : 'https://via.placeholder.com/150';
      const statusClass = s.status === 'pass' ? 'pass' : (s.status === 'fail' ? 'fail' : 'not-produced');
      const card = $(`
        <div class="scenario-card mb-3" data-id="${s.id}">
          <img src="${img}" alt="img">
          <div style="flex:1">
            <h5 class="mb-1">${escapeHtml(cfg.title)}</h5>
            <p class="mb-1 small text-muted">Status: <span class="scenario-status ${statusClass}">${(s.status||'').toUpperCase()}</span></p>
            <p class="mb-2 small">${escapeHtml((s.explanation||'').slice(0,100))}${(s.explanation && s.explanation.length>100? '...' : '')}</p>
            <div class="btn-group btn-group-sm">
              <button class="btn btn-info btn-view" data-id="${s.id}"><i class="fas fa-eye"></i> View</button>
              <button class="btn btn-warning btn-edit" data-id="${s.id}"><i class="fas fa-edit"></i> Edit</button>
              <button class="btn btn-danger btn-delete" data-id="${s.id}"><i class="fas fa-trash"></i> Delete</button>
            </div>
          </div>
        </div>
      `);
      container.append(card);
    });
  }

  function renderConfigurations(){
    const list = $('#config-list').empty();
    if (!configurations.length){
      list.html('<div class="alert alert-info text-center">No configurations found. Add new ones.</div>');
      return;
    }
    configurations.forEach(c => {
      const el = $(`
        <div class="list-group-item d-flex justify-content-between align-items-center mb-2 card">
          <div class="w-75">
            <h5 class="mb-1">${escapeHtml(c.title)}</h5>
            <p class="mb-1 small text-muted">${escapeHtml((c.description||'').slice(0,120))}${(c.description && c.description.length>120? '...' : '')}</p>
            <p class="mb-0 small"><strong>Entry:</strong> ${escapeHtml(c.entryPoint||'N/A')} | <strong>Exit:</strong> ${escapeHtml(c.exitPoint||'N/A')}</p>
          </div>
          <div class="btn-group btn-group-sm">
            <button class="btn btn-info btn-view-config" data-id="${c.id}"><i class="fas fa-eye"></i> View</button>
            <button class="btn btn-warning btn-edit-config" data-id="${c.id}"><i class="fas fa-edit"></i> Edit</button>
            <button class="btn btn-danger btn-delete-config" data-id="${c.id}"><i class="fas fa-trash-alt"></i> Delete</button>
            <button class="btn btn-secondary btn-copy-config" data-id="${c.id}"><i class="fas fa-copy"></i> Copy</button>
          </div>
        </div>
      `);
      list.append(el);
    });
  }

  function renderReport(from=null,to=null){
    const tbody = $('#report-table tbody').empty();
    const summary = { total:0, pass:0, fail:0, 'not-produced':0 };
    const grouped = {}; // scenarioTitle => [items]
    const rows = [];

    Object.keys(dailyScenarios).sort().forEach(date => {
      if (from && date < from) return;
      if (to && date > to) return;
      (dailyScenarios[date]||[]).forEach(s => {
        const cfg = configurations.find(c=>c.id==s.configId) || { title:'Unknown' };
        summary.total++;
        if (s.status) summary[s.status] = (summary[s.status]||0) + 1;
        const passed = (s.rules||[]).filter(r=>r.status==='pass').length;
        rows.push({ title: cfg.title, date, status: s.status||'N/A', passed, totalRules:(s.rules||[]).length, explanation: s.explanation||'', id: s.id });
        if (!grouped[cfg.title]) grouped[cfg.title] = [];
        grouped[cfg.title].push({ date, status: s.status||'N/A' });
      });
    });

    // summary badges
    const total = summary.total || 0;
    const summaryHtml = `
      <div class="row text-center fw-bold mb-2">
        <div class="col-md-3">Total: <span class="badge bg-primary">${total}</span></div>
        <div class="col-md-3">Pass: <span class="badge bg-success">${summary.pass||0} (${total?((summary.pass/total*100).toFixed(1)):'0.0'}%)</span></div>
        <div class="col-md-3">Fail: <span class="badge bg-danger">${summary.fail||0} (${total?((summary.fail/total*100).toFixed(1)):'0.0'}%)</span></div>
        <div class="col-md-3">Not Produced: <span class="badge bg-warning">${summary['not-produced']||0} (${total?(((summary['not-produced']||0)/total*100).toFixed(1)):'0.0'}%)</span></div>
      </div>
    `;

    // scenario-wise grouped cards
    let groupedHtml = '<div class="mb-3">';
    Object.keys(grouped).forEach(title => {
      groupedHtml += `<div class="card mb-2"><div class="card-header fw-bold">${escapeHtml(title)}</div><div class="card-body"><div class="row">`;
      grouped[title].forEach(item => {
        groupedHtml += `<div class="col-md-3 mb-2"><div class="p-2" style="background:${item.status==='pass'?'#e8f5e9':(item.status==='fail'?'#ffebee':'#fff7e6')};border-radius:8px"><strong>${item.date}</strong><div><span class="badge ${item.status==='pass'?'badge-pass':item.status==='fail'?'badge-fail':'badge-not'}">${(item.status||'').toUpperCase()}</span></div></div></div>`;
      });
      groupedHtml += '</div></div></div>';
    });
    groupedHtml += '</div>';

    $('#report-summary').html(summaryHtml + groupedHtml);

    // detailed rows
    rows.forEach(r => {
      const cls = r.status==='pass' ? 'bg-success text-white' : (r.status==='fail' ? 'bg-danger text-white' : 'bg-warning text-dark');
      tbody.append(`<tr>
        <td>${escapeHtml(r.title)}</td>
        <td>${r.date}</td>
        <td><span class="badge ${cls}">${(r.status||'').toUpperCase()}</span></td>
        <td>${r.passed} of ${r.totalRules}</td>
        <td>${escapeHtml(r.explanation.slice(0,60))}${(r.explanation.length>60?'...':'')}</td>
        <td><button class="btn btn-info btn-sm btn-view-report" data-id="${r.id}"><i class="fas fa-info-circle"></i> Details</button></td>
      </tr>`);
    });
  }

  // Init defaults
  $('#date-picker').val(todayISO());

  // Event bindings

  // Login
  $('#login-form').on('submit', function(e){
    e.preventDefault();
    const u = $('#username').val().trim(), p = $('#password').val();
    if (u === 'local' && p === 'local1234'){
      $('#login-page').hide();
      $('#main-app').show();
      populateScenarioDropdown();
      renderDailyScenarios();
      renderConfigurations();
      renderReport();
    } else {
      $('#login-error').text('Invalid username or password').show();
    }
  });

  // Open Add Scenario modal
  $('#add-new-scenario').on('click', function(){
    $('#scenario-form')[0].reset();
    $('#daily-scenario-id').val('');
    currentImages = [];
    $('#image-preview-container').empty();
    $('#daily-rules-container').html('<div class="alert alert-info text-center">Select a scenario to load rules.</div>');
    populateScenarioDropdown();
    $('#addScenarioTitle').text('Add Daily Scenario');
    bootstrap.Modal.getOrCreateInstance(document.getElementById('addScenarioModal')).show();
  });

  // scenario-select change -> load rules from rules_<configId>
  $('#scenario-select').on('change', function(){
    const cfgId = $(this).val();
    $('#daily-rules-container').empty();
    if (!cfgId){
      $('#daily-rules-container').html('<div class="alert alert-info text-center">Select a scenario to load rules.</div>');
      return;
    }
    const rules = JSON.parse(localStorage.getItem('rules_' + cfgId) || '[]');
    if (!rules.length){
      $('#daily-rules-container').html('<div class="alert alert-warning text-center">No rules configured for this scenario. Use Manage Rules in Configuration to add.</div>');
      return;
    }
    rules.forEach(r => {
      $('#daily-rules-container').append(`
        <div class="card p-2 mb-2 rule-item" data-rule-id="${r.id}">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <h6 class="mb-1">${escapeHtml(r.name)}</h6>
              <small class="text-muted">${escapeHtml(r.condition || '')}</small>
            </div>
          </div>
          <div class="row g-2 mt-2">
            <div class="col-md-3">
              <select class="form-select status-select">
                <option value="pass">Pass</option>
                <option value="fail">Fail</option>
              </select>
            </div>
            <div class="col-md-9">
              <textarea class="form-control comment-input" rows="1" placeholder="Comment"></textarea>
            </div>
          </div>
        </div>
      `);
    });
  });

  // Image upload preview
  $('#image-upload').on('change', function(){
    const files = this.files;
    if (!files) return;
    Array.from(files).forEach(file=>{
      const reader = new FileReader();
      reader.onload = function(e){
        currentImages.push(e.target.result);
        renderImagePreviews();
      };
      reader.readAsDataURL(file);
    });
    $(this).val('');
  });

  function renderImagePreviews(){
    const cont = $('#image-preview-container').empty();
    currentImages.forEach((img,i)=>{
      const el = $(`
        <div class="position-relative image-preview-item">
          <img src="${img}" alt="preview" />
          <span class="remove-btn" data-index="${i}">&times;</span>
        </div>
      `);
      cont.append(el);
    });
  }

  $(document).on('click', '.remove-btn', function(){ const idx = $(this).data('index'); currentImages.splice(idx,1); renderImagePreviews(); });

  // SAVE scenario with robust date-keyed storage
  $('#save-daily-scenario').on('click', function(){
    const id = $('#daily-scenario-id').val() || Date.now().toString();
    const cfgId = $('#scenario-select').val();
    const date = $('#date-picker').val();
    const status = $('#status-select').val();
    const explanation = $('#explanation-input').val();

    if (!cfgId){ alert('Select a scenario configuration'); return; }
    if (!date){ alert('Select a date'); return; }
    if (!status){ alert('Select a status'); return; }

    // collect rules (if any)
    const rules = [];
    $('#daily-rules-container .rule-item').each(function(){
      const ruleId = $(this).data('rule-id');
      const ruleStatus = $(this).find('.status-select').val();
      const comment = $(this).find('.comment-input').val();
      rules.push({ id: ruleId, status: ruleStatus, comment });
    });

    // scenario object
    const scenarioObj = { id, configId: cfgId, status, explanation, rules, images: currentImages.slice() };

    // remove this id anywhere it exists (prevent duplicates across dates)
    Object.keys(dailyScenarios).forEach(d => {
      dailyScenarios[d] = (dailyScenarios[d] || []).filter(s => s.id !== id);
      if (!dailyScenarios[d].length) delete dailyScenarios[d];
    });

    // ensure date bucket and push
    if (!dailyScenarios[date]) dailyScenarios[date] = [];
    dailyScenarios[date].push(scenarioObj);

    persistData();

    // close modal
    bootstrap.Modal.getOrCreateInstance(document.getElementById('addScenarioModal')).hide();

    // reset form and images
    $('#scenario-form')[0].reset();
    $('#image-preview-container').empty();
    currentImages = [];
    $('#daily-scenario-id').val('');

    // refresh views
    renderDailyScenarios();
    renderReport();
  });

  // Edit/View/Delete handlers
  $(document).on('click', '.btn-edit', function(){
    const id = $(this).data('id');
    let found = null, foundDate = null;
    Object.keys(dailyScenarios).forEach(d=>{
      dailyScenarios[d].forEach(s=>{ if (s.id == id){ found = s; foundDate = d; }});
    });
    if (!found) return alert('Scenario not found');

    $('#daily-scenario-id').val(found.id);
    $('#status-select').val(found.status);
    $('#explanation-input').val(found.explanation);
    currentImages = (found.images||[]).slice();
    renderImagePreviews();

    populateScenarioDropdown();
    $('#scenario-select').val(found.configId).trigger('change');

    // populate rules area with saved values
    const defs = JSON.parse(localStorage.getItem('rules_' + found.configId) || '[]');
    const container = $('#daily-rules-container').empty();
    if (!defs.length){
      container.html('<div class="alert alert-warning text-center">No rules configured for this scenario config.</div>');
    } else {
      defs.forEach(def => {
        const saved = (found.rules||[]).find(r=>r.id==def.id) || { status:'pass', comment:'' };
        container.append(`
          <div class="card p-2 mb-2 rule-item" data-rule-id="${def.id}">
            <h6 class="mb-1">${escapeHtml(def.name)}</h6>
            <p class="small text-muted">Condition: ${escapeHtml(def.condition||'')}</p>
            <div class="row g-2">
              <div class="col-md-3"><select class="form-select status-select"><option value="pass" ${saved.status==='pass'?'selected':''}>Pass</option><option value="fail" ${saved.status==='fail'?'selected':''}>Fail</option></select></div>
              <div class="col-md-9"><textarea class="form-control comment-input" rows="1">${escapeHtml(saved.comment||'')}</textarea></div>
            </div>
          </div>
        `);
      });
    }

    $('#addScenarioTitle').text('Edit Daily Scenario');
    bootstrap.Modal.getOrCreateInstance(document.getElementById('addScenarioModal')).show();
  });

  $(document).on('click', '.btn-view', function(){
    const id = $(this).data('id');
    let found = null, foundDate = null;
    Object.keys(dailyScenarios).forEach(d=>{
      dailyScenarios[d].forEach(s=>{ if (s.id == id){ found = s; foundDate = d; }});
    });
    if (!found) return alert('Scenario not found');

    const cfg = configurations.find(c=>c.id==found.configId) || { title:'Unknown' };
    const defs = JSON.parse(localStorage.getItem('rules_' + found.configId) || '[]');
    let rulesHtml = '<div class="alert alert-info">No rules configured.</div>';
    if (found.rules && found.rules.length && defs.length){
      rulesHtml = '<ul class="list-group">';
      found.rules.forEach(r=>{
        const def = defs.find(d=>d.id==r.id) || {};
        rulesHtml += `<li class="list-group-item"><h6 class="mb-1">${escapeHtml(def.name || 'Unknown')}</h6><p class="mb-1"><strong>Status:</strong> <span class="badge ${r.status==='pass'?'bg-success':'bg-danger'}">${(r.status||'').toUpperCase()}</span></p>${r.comment?`<p class="mb-0"><strong>Comment:</strong> ${escapeHtml(r.comment)}</p>`:''}</li>`;
      });
      rulesHtml += '</ul>';
    }

    // === START Image popup change ===
	const imagesHtml = (found.images || []).length ?
	(found.images.map((img,i)=>`
		<div class="col-md-4 mb-3">
		<a href="${img}" target="_blank">
			<div class="zoom-wrap"><img src="${img}" class="zoom-img" data-index="${i}" /></div>
		</a>
		</div>`).join(''))
	: '<div class="col"><p>No images uploaded.</p></div>';
	// === END Image popup change ===


    $('#view-scenario-body').html(`
      <p><strong>Scenario Title:</strong> ${escapeHtml(cfg.title)}</p>
      <p><strong>Date:</strong> ${foundDate}</p>
      <p><strong>Status:</strong> <span class="badge ${found.status==='pass'?'bg-success':(found.status==='fail'?'bg-danger':'bg-warning')}">${(found.status||'').toUpperCase()}</span></p>
      <p><strong>Explanation:</strong> ${escapeHtml(found.explanation||'N/A')}</p>
      <hr />
      <h6>Rules:</h6>
      ${rulesHtml}
      <hr />
      <h6>Images:</h6>
      <div class="row">${imagesHtml}</div>
    `);

    // store context for manage rules if user opens from view (we disable direct manage button here)
    manageRulesForConfig = found.configId;
    $('#rules-scenario-title').text( configurations.find(c=>c.id==found.configId)?.title || '' );

    bootstrap.Modal.getOrCreateInstance(document.getElementById('viewScenarioModal')).show();

    // init simple pan/zoom for images
    setTimeout(()=>{ initPanZoom('.zoom-img'); }, 100);
  });

  $(document).on('click', '.btn-delete', function(){
    const id = $(this).data('id');
    if (!confirm('Delete this scenario?')) return;
    Object.keys(dailyScenarios).forEach(d=>{
      dailyScenarios[d] = (dailyScenarios[d]||[]).filter(s=>s.id!=id);
      if (!dailyScenarios[d].length) delete dailyScenarios[d];
    });
    persistData();
    renderDailyScenarios();
    renderReport();
  });

  // === FIX: open scenario directly from report, independent of Daily tab ===
$(document).on('click', '.btn-view-report', function () {
  const id = $(this).data('id');

  // locate scenario across all stored dates
  let found = null, foundDate = null;
  Object.keys(dailyScenarios).forEach(d => {
    (dailyScenarios[d] || []).forEach(s => {
      if (s.id === id) { found = s; foundDate = d; }
    });
  });
  if (!found) return alert('Scenario not found');

  const cfg  = configurations.find(c => c.id === found.configId) || { title: 'Unknown' };
  const defs = JSON.parse(localStorage.getItem('rules_' + found.configId) || '[]');

  // build rules HTML
  let rulesHtml = '<div class="alert alert-info">No rules configured.</div>';
  if (found.rules && found.rules.length && defs.length) {
    rulesHtml = '<ul class="list-group">';
    found.rules.forEach(r => {
      const def = defs.find(d => d.id === r.id) || {};
      rulesHtml += `<li class="list-group-item">
                      <h6 class="mb-1">${escapeHtml(def.name || 'Unknown')}</h6>
                      <p class="mb-1"><strong>Status:</strong>
                        <span class="badge ${r.status==='pass'?'bg-success':'bg-danger'}">${(r.status||'').toUpperCase()}</span>
                      </p>
                      ${r.comment ? `<p class="mb-0"><strong>Comment:</strong> ${escapeHtml(r.comment)}</p>` : ''}
                    </li>`;
    });
    rulesHtml += '</ul>';
  }

  // build images HTML (use data-safe single-tap zoom only)
  const imagesHtml = (found.images || []).length
    ? found.images.map((img,i)=>`
        <div class="col-md-4 mb-3">
          <div class="zoom-wrap">
            <img src="${img}" class="zoom-img safe-zoom" data-index="${i}" />
          </div>
        </div>`).join('')
    : '<div class="col"><p>No images uploaded.</p></div>';

  $('#view-scenario-body').html(`
    <p><strong>Scenario Title:</strong> ${escapeHtml(cfg.title)}</p>
    <p><strong>Date:</strong> ${foundDate}</p>
    <p><strong>Status:</strong>
       <span class="badge ${found.status==='pass'?'bg-success':(found.status==='fail'?'bg-danger':'bg-warning')}">
         ${(found.status||'').toUpperCase()}
       </span>
    </p>
    <p><strong>Explanation:</strong> ${escapeHtml(found.explanation||'N/A')}</p>
    <hr><h6>Rules:</h6>${rulesHtml}
    <hr><h6>Images:</h6><div class="row">${imagesHtml}</div>
  `);

  bootstrap.Modal.getOrCreateInstance(document.getElementById('viewScenarioModal')).show();
  setTimeout(()=>{ initPanZoom('.safe-zoom'); },100);
});

  // Config CRUD
  $('#open-add-config').on('click', function(){
    $('#config-form')[0].reset();
    $('#config-id').val('');
    $('#configModalTitle').text('Add Configuration');
    bootstrap.Modal.getOrCreateInstance(document.getElementById('addConfigModal')).show();
  });

  $('#save-config').on('click', function(){
    const id = $('#config-id').val() || Date.now().toString();
    const title = $('#config-title').val().trim();
    if (!title) return alert('Enter title');
    const description = $('#config-description').val();
    const entry = $('#entry-point').val();
    const exit = $('#exit-point').val();
    const idx = configurations.findIndex(c=>c.id==id);
    const cfg = { id, title, description, entryPoint: entry, exitPoint: exit };
    if (idx >= 0) configurations[idx] = cfg; else configurations.push(cfg);
    // ensure rules bucket exists
    if (!localStorage.getItem('rules_' + id)) localStorage.setItem('rules_' + id, JSON.stringify([]));
    persistData();
    renderConfigurations();
    populateScenarioDropdown();
    bootstrap.Modal.getOrCreateInstance(document.getElementById('addConfigModal')).hide();
  });

  $(document).on('click', '.btn-view-config', function(){
    const id = $(this).data('id');
    const cfg = configurations.find(c=>c.id==id);
    if (!cfg) return alert('Config not found');
    const rules = JSON.parse(localStorage.getItem('rules_' + id) || '[]');
    const rulesHtml = rules.length ? rules.map(r=>`<li class="list-group-item"><h6>${escapeHtml(r.name)}</h6><small class="text-muted">${escapeHtml(r.condition||'')}</small></li>`).join('') : '<div class="alert alert-info">No rules configured.</div>';
    $('#view-config-body').html(`<p><strong>Title:</strong> ${escapeHtml(cfg.title)}</p><p><strong>Description:</strong> ${escapeHtml(cfg.description||'')}</p><p><strong>Entry:</strong> ${escapeHtml(cfg.entryPoint||'N/A')} | <strong>Exit:</strong> ${escapeHtml(cfg.exitPoint||'N/A')}</p><hr><h6>Rules:</h6><ul class="list-group">${rulesHtml}</ul>`);
    bootstrap.Modal.getOrCreateInstance(document.getElementById('viewConfigModal')).show();
  });

  $(document).on('click', '.btn-edit-config', function(){
    const id = $(this).data('id');
    const cfg = configurations.find(c=>c.id==id);
    if (!cfg) return;
    $('#config-id').val(cfg.id);
    $('#config-title').val(cfg.title);
    $('#config-description').val(cfg.description);
    $('#entry-point').val(cfg.entryPoint);
    $('#exit-point').val(cfg.exitPoint);
    $('#configModalTitle').text('Edit Configuration');
    bootstrap.Modal.getOrCreateInstance(document.getElementById('addConfigModal')).show();
  });

  $(document).on('click', '.btn-delete-config', function(){
    const id = $(this).data('id');
    if (!confirm('Delete configuration and related scenarios?')) return;
    configurations = configurations.filter(c=>c.id!=id);
    Object.keys(dailyScenarios).forEach(d=>{
      dailyScenarios[d] = (dailyScenarios[d]||[]).filter(s=>s.configId!=id);
      if (!dailyScenarios[d].length) delete dailyScenarios[d];
    });
    localStorage.removeItem('rules_' + id);
    persistData();
    renderConfigurations();
    renderDailyScenarios();
    renderReport();
    populateScenarioDropdown();
  });

  $(document).on('click', '.btn-copy-config', function(){
    const id = $(this).data('id');
    const cfg = configurations.find(c=>c.id==id);
    if (!cfg) return;
    const newCfg = JSON.parse(JSON.stringify(cfg));
    newCfg.id = Date.now().toString();
    newCfg.title = cfg.title + ' (Copy)';
    configurations.push(newCfg);
    const rules = JSON.parse(localStorage.getItem('rules_' + id) || '[]');
    localStorage.setItem('rules_' + newCfg.id, JSON.stringify(rules));
    persistData();
    renderConfigurations();
    populateScenarioDropdown();
  });

  // Manage rules from config modal
  $('#manage-config-rules').on('click', function(){
    let cfgId = $('#config-id').val();
    // If config isn't saved yet, create and persist it first
    if(!cfgId){
      cfgId = Date.now().toString();
      $('#config-id').val(cfgId);
      const title = $('#config-title').val().trim() || 'Untitled';
      const description = $('#config-description').val() || '';
      const entry = $('#entry-point').val() || '';
      const exit = $('#exit-point').val() || '';
      const cfg = { id: cfgId, title, description, entryPoint: entry, exitPoint: exit };
      configurations.push(cfg);
      // ensure rules bucket exists
      if (!localStorage.getItem('rules_' + cfgId)) localStorage.setItem('rules_' + cfgId, JSON.stringify([]));
      persistData();
      renderConfigurations();
      populateScenarioDropdown();
    }
    manageRulesForConfig = cfgId;
    $('#rules-scenario-title').text($('#config-title').val() || 'Untitled');
    const rules = JSON.parse(localStorage.getItem('rules_' + cfgId) || '[]');
    renderRulesList(rules);
    bootstrap.Modal.getOrCreateInstance(document.getElementById('addConfigModal')).hide();
    bootstrap.Modal.getOrCreateInstance(document.getElementById('manageRulesModal')).show();
  });

  // Manage rules from view modal (hidden manage button earlier; this keeps capability)
  $('#view-manage-rules').on('click', function(){
    if (!manageRulesForConfig) return alert('No configuration context for rules');
    $('#rules-scenario-title').text( configurations.find(c=>c.id==manageRulesForConfig)?.title || '');
    const rules = JSON.parse(localStorage.getItem('rules_' + manageRulesForConfig) || '[]');
    renderRulesList(rules);
    bootstrap.Modal.getOrCreateInstance(document.getElementById('viewScenarioModal')).hide();
    bootstrap.Modal.getOrCreateInstance(document.getElementById('manageRulesModal')).show();
  });

  // Render rules list in manage rules modal
  function renderRulesList(rules){
    const list = $('#rules-list').empty();
    if (!rules.length) list.html('<div class="alert alert-info">No rules yet. Add one below.</div>');
    rules.forEach(r => {
      list.append(`<li class="list-group-item d-flex justify-content-between align-items-center" data-id="${r.id}"><div><h6 class="mb-0">${escapeHtml(r.name)}</h6><small class="text-muted">${escapeHtml(r.condition||'')}</small></div><button class="btn btn-danger btn-sm remove-rule" data-id="${r.id}"><i class="fas fa-times"></i></button></li>`);
    });
  }

  // Add rule in manage rules modal
  $('#add-rule-btn').on('click', function(){
    const name = $('#rule-name').val().trim();
    if (!name) return alert('Enter rule name');
    const condition = $('#rule-condition').val();
    const id = Date.now().toString();
    const key = 'rules_' + manageRulesForConfig;
    const rules = JSON.parse(localStorage.getItem(key) || '[]');
    rules.push({ id, name, condition });
    localStorage.setItem(key, JSON.stringify(rules));
    $('#rule-name').val(''); $('#rule-condition').val('');
    renderRulesList(rules);
  });

  // Remove rule
  $(document).on('click', '.remove-rule', function(){
    const id = $(this).data('id');
    const key = 'rules_' + manageRulesForConfig;
    let rules = JSON.parse(localStorage.getItem(key) || '[]');
    rules = rules.filter(r=>r.id!=id);
    localStorage.setItem(key, JSON.stringify(rules));
    renderRulesList(rules);
  });

  // When closing manageRulesModal, reopen the modal we came from (config or scenario) for continuity
  $('#manageRulesModal').on('hidden.bs.modal', function(){
    // Refresh dropdowns / lists
    populateScenarioDropdown();
    renderConfigurations();
    // reopen addConfigModal if we were editing config (config title or id present)
    if ($('#config-title').val() || $('#config-id').val()) {
      bootstrap.Modal.getOrCreateInstance(document.getElementById('addConfigModal')).show();
    } else {
      // reopen scenario modal if it was previously open
      if ($('#addScenarioModal')) bootstrap.Modal.getOrCreateInstance(document.getElementById('addScenarioModal')).show();
    }
  });

  // Report filter
  $('#filter-report').on('click', function(){
    const from = $('#report-from').val() || null;
    const to = $('#report-to').val() || null;
    renderReport(from,to);
  });

  // Refresh and date change
  $('#refresh-daily').on('click', function(){ renderDailyScenarios(); });
  $('#date-picker').on('change', function(){ renderDailyScenarios(); });

  // Simple pan/zoom for images (lightweight)
  function initPanZoom(selector){
    document.querySelectorAll(selector).forEach(img => {
      if (img._pz) return;
      img._pz = true;
      let scale = 1, pos = {x:0,y:0}, last = null, pointers = {};
	        // Prevent double-tap zoom crashes
      img.addEventListener('dblclick', e => {
        e.preventDefault();
        // reset to original
        scale = 1; pos = {x:0,y:0};
        img.style.transform = `translate(0,0) scale(1)`;
      });
      img.style.transformOrigin = '0 0';
      img.style.touchAction = 'none';
      img.addEventListener('pointerdown', e => { img.setPointerCapture(e.pointerId); pointers[e.pointerId] = {x:e.clientX,y:e.clientY}; last = {x:e.clientX,y:e.clientY}; });
      img.addEventListener('pointermove', e => {
        if (!pointers[e.pointerId]) return;
        pointers[e.pointerId] = {x:e.clientX,y:e.clientY};
        const ks = Object.keys(pointers).length;
        if (ks === 1 && last){
          const dx = e.clientX - last.x;
          const dy = e.clientY - last.y;
          pos.x += dx; pos.y += dy;
          img.style.transform = `translate(${pos.x}px, ${pos.y}px) scale(${scale})`;
          last = {x:e.clientX,y:e.clientY};
        } else if (ks === 2){
          const pts = Object.values(pointers);
          const dist = Math.hypot(pts[0].x-pts[1].x, pts[0].y-pts[1].y);
          if (!img._baseDist){ img._baseDist = dist; img._baseScale = scale; }
          else { scale = Math.max(1, Math.min(5, img._baseScale * (dist / img._baseDist))); img.style.transform = `translate(${pos.x}px, ${pos.y}px) scale(${scale})`; }
        }
      });
      img.addEventListener('pointerup', e => { delete pointers[e.pointerId]; last = null; img._baseDist = null; img._baseScale = scale; });
      img.addEventListener('pointercancel', e => { delete pointers[e.pointerId]; last = null; img._baseDist = null; img._baseScale = scale; });
      img.addEventListener('wheel', e => { e.preventDefault(); const factor = e.deltaY < 0 ? 1.08 : 0.92; scale = Math.max(1, Math.min(5, scale*factor)); img.style.transform = `translate(${pos.x}px, ${pos.y}px) scale(${scale})`; });
    });
  }

  // Initial render
  (function init(){
    populateScenarioDropdown();
    renderDailyScenarios();
    renderConfigurations();
    renderReport();
  })();

  // Persist on storage event (other tabs)
  window.addEventListener('storage', function(){
    dailyScenarios = JSON.parse(localStorage.getItem('dailyScenarios') || '{}');
    configurations = JSON.parse(localStorage.getItem('configurations') || '[]');
    populateScenarioDropdown();
    renderDailyScenarios();
    renderConfigurations();
    renderReport();
  });

});
</script>
</body>
</html>
